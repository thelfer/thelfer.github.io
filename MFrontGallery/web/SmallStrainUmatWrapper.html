<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<!--[if lt IE 7]>      <html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
<!--[if IE 7]>         <html class="no-js lt-ie9 lt-ie8"> <![endif]-->
<!--[if IE 8]>         <html class="no-js lt-ie9"> <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js"> <!--<![endif]-->
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-EN" xml:lang="en-EN">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta http-equiv="Content-Style-Type" content="text/css" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
    <meta name="generator" content="pandoc" />
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <title>Introducing small strain legacy Abaqus/UMAT implementations in MFrontGallery</title>
        <meta name="author" content="Thomas Helfer, Eric Simo" />
            <meta name="date" content="2022-09-03" />
        <!-- Place favicon.ico and apple-touch-icon.png in the root directory -->
    <style type="text/css">code{white-space: pre;}</style>
            <style type="text/css">
      pre > code.sourceCode { white-space: pre; position: relative; }
      pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
      pre > code.sourceCode > span:empty { height: 1.2em; }
      code.sourceCode > span { color: inherit; text-decoration: inherit; }
      div.sourceCode { margin: 1em 0; }
      pre.sourceCode { margin: 0; }
      @media screen {
      div.sourceCode { overflow: auto; }
      }
      @media print {
      pre > code.sourceCode { white-space: pre-wrap; }
      pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
      }
      pre.numberSource code
        { counter-reset: source-line 0; }
      pre.numberSource code > span
        { position: relative; left: -4em; counter-increment: source-line; }
      pre.numberSource code > span > a:first-child::before
        { content: counter(source-line);
          position: relative; left: -1em; text-align: right; vertical-align: baseline;
          border: none; display: inline-block;
          -webkit-touch-callout: none; -webkit-user-select: none;
          -khtml-user-select: none; -moz-user-select: none;
          -ms-user-select: none; user-select: none;
          padding: 0 4px; width: 4em;
          color: #aaaaaa;
        }
      pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
      div.sourceCode
        {  background-color: #f8f8f8; }
      @media screen {
      pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
      }
      code span.al { color: #ef2929; } /* Alert */
      code span.an { color: #8f5902; font-weight: bold; font-style: italic; } /* Annotation */
      code span.at { color: #c4a000; } /* Attribute */
      code span.bn { color: #0000cf; } /* BaseN */
      code span.cf { color: #204a87; font-weight: bold; } /* ControlFlow */
      code span.ch { color: #4e9a06; } /* Char */
      code span.cn { color: #000000; } /* Constant */
      code span.co { color: #8f5902; font-style: italic; } /* Comment */
      code span.cv { color: #8f5902; font-weight: bold; font-style: italic; } /* CommentVar */
      code span.do { color: #8f5902; font-weight: bold; font-style: italic; } /* Documentation */
      code span.dt { color: #204a87; } /* DataType */
      code span.dv { color: #0000cf; } /* DecVal */
      code span.er { color: #a40000; font-weight: bold; } /* Error */
      code span.ex { } /* Extension */
      code span.fl { color: #0000cf; } /* Float */
      code span.fu { color: #000000; } /* Function */
      code span.im { } /* Import */
      code span.in { color: #8f5902; font-weight: bold; font-style: italic; } /* Information */
      code span.kw { color: #204a87; font-weight: bold; } /* Keyword */
      code span.op { color: #ce5c00; font-weight: bold; } /* Operator */
      code span.ot { color: #8f5902; } /* Other */
      code span.pp { color: #8f5902; font-style: italic; } /* Preprocessor */
      code span.sc { color: #000000; } /* SpecialChar */
      code span.ss { color: #4e9a06; } /* SpecialString */
      code span.st { color: #4e9a06; } /* String */
      code span.va { color: #000000; } /* Variable */
      code span.vs { color: #4e9a06; } /* VerbatimString */
      code span.wa { color: #8f5902; font-weight: bold; font-style: italic; } /* Warning */
    </style>
            <link rel="stylesheet" href="css/normalize.css"/>
    <link rel="stylesheet" href="css/main.css"/>
        <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>
          </head>
  <body>
    <!--[if lt IE 7]>
        <p class="browsehappy">You are using an <strong>outdated</strong> browser. Please <a href="http://browsehappy.com/">upgrade your browser</a> to improve your experience.</p>
    <![endif]-->
        <header>
      <ul id="nav">
	    <li><a href="index.html">Overview</a></li>
        <li><a>Documentation</a>
      	  <ul>
	        <li><a href="install.html">Installation guide</a></li>
	        <li><a href="creating-derived-project.html">Creating derived project</a></li>
	        <li><a href="cmake-infrastructure.html">CMake infrastructure</a></li>
	        <li><a href="best-practices.html">Best practices</a></li>
            <li><a href="contributing.html">Contributing</a></li>
            <li><a>Tutorials</a>
                <ul>
                <li><a href="SmallStrainUmatWrapper.html">Small-strain UMAT wrapper</a></li>
                </ul>
            </li>
	      </ul>
        </li>
        <li><a>Materials</a>
          <ul>
             <li><a>Concrete</a>
                <ul>
                   <li><a>Behaviours</a>
                     <ul>
                       <li><a href="Burger_EDF_CIWAP_2021.html">Burger_EDF_CIWAP_2021</a></li>
                     </ul>
                   </li>
                </ul>
             </li>
             <li><a>Crushed Salt</a>
                <ul>
                   <li><a>Behaviours</a>
                     <ul>
                       <li><a href="CrushedSaltKorthausBehaviour.html">Korthaus' behaviour</a></li>
                     </ul>
                   </li>
                </ul>
             </li>
          </ul>
        </li>
        <li><a>Behaviours</a>
          <ul>
             <li><a>Plasticity</a>
                <ul>
                  <li><a href="SemiImplicitModifiedCamClay_OpenGeoSys2020.html">SemiImplicitModifiedCamClay_OpenGeoSys2020</a></li>
                </ul>
             </li>
          </ul>
        </li>
        <li><a>Getting Help</a>
      	  <ul>
	        <li><a href="https://github.com/thelfer/MFrontGallery/discussions">Forum</a></li>
	        <li><a href="faq.html">FAQ</a></li>
	        <li><a href="mailto:tfel-contact@cea.fr">Contact</a></li>
	      </ul>
       </li>
        <li><a>About</a>
      	  <ul>
	        <li><a href="contributors.html">Contributors</a></li>
	      </ul>
       </li>
      </ul><br>
    </header>

<div id="header">
<h1 class="title">Introducing small strain legacy <code>Abaqus/UMAT</code> implementations in <code>MFrontGallery</code></h1>
<h2 class="author">Thomas Helfer, Eric Simo</h2>
<h3 class="date">09/03/2022</h3>
</div>
<div id="TOC">
<ul>
<li><a href="#description-of-the-wrapped-umat-implementation-and-role-of-the-wrapper"><span class="toc-section-number">1</span> Description of the wrapped <code>UMAT</code> implementation and role of the wrapper</a></li>
<li><a href="#sec:umat_wrapper:MFrontUmatWrapper"><span class="toc-section-number">2</span> Description of the <code>MFrontUmatWrapper.hxx</code> header file</a></li>
<li><a href="#sec:umat_wrapper:material_properties"><span class="toc-section-number">3</span> Treatment of the material properties</a>
<ul>
<li><a href="#the-generic-behaviour-case"><span class="toc-section-number">3.1</span> The generic behaviour case</a></li>
<li><a href="#the-self-contained-case"><span class="toc-section-number">3.2</span> The self-contained case</a></li>
</ul></li>
<li><a href="#implementation-of-the-umat-wrapper-in-mfront"><span class="toc-section-number">4</span> Implementation of the <code>UMAT</code> wrapper in <code>MFront</code></a>
<ul>
<li><a href="#a-quick-overview-of-fortran-77c-interoperability"><span class="toc-section-number">4.1</span> A quick overview of <code>fortran 77</code>/<code>C++</code> interoperability</a></li>
<li><a href="#choice-of-the-domain-specific-languagemfront"><span class="toc-section-number">4.2</span> Choice of the domain specific language<code>MFront</code></a></li>
<li><a href="#some-metadata"><span class="toc-section-number">4.3</span> Some metadata</a></li>
<li><a href="#restricting-the-allowed-modelling-hypothesis"><span class="toc-section-number">4.4</span> Restricting the allowed modelling hypothesis</a></li>
<li><a href="#including-the-mfrontumatwrapper-file"><span class="toc-section-number">4.5</span> Including the <code>MFrontUmatWrapper</code> file</a></li>
<li><a href="#elastic-properties"><span class="toc-section-number">4.6</span> Elastic properties</a></li>
<li><a href="#local-variable"><span class="toc-section-number">4.7</span> Local variable</a></li>
<li><a href="#implementation-of-the-behaviour-integration"><span class="toc-section-number">4.8</span> Implementation of the behaviour integration</a></li>
<li><a href="#sec:umat_wrapper:tangent_operator"><span class="toc-section-number">4.9</span> Conversion of the tangent operator</a></li>
</ul></li>
<li><a href="#compiling-the-wrapper-outside-the-mfrontgallery"><span class="toc-section-number">5</span> Compiling the wrapper outside the <code>MFrontGallery</code></a>
<ul>
<li><a href="#compiling-the-umat.f-file"><span class="toc-section-number">5.1</span> Compiling the <code>umat.f</code> file</a></li>
<li><a href="#compiling-the-mfront-wrapper"><span class="toc-section-number">5.2</span> Compiling the <code>MFront</code> wrapper</a></li>
<li><a href="#running-a-simple-test-with-mtest"><span class="toc-section-number">5.3</span> Running a simple test with <code>MTest</code></a></li>
</ul></li>
<li><a href="#sec:umat_wrapper:fortran95"><span class="toc-section-number">6</span> A better solution</a>
<ul>
<li><a href="#modification-of-the-fortran-sources"><span class="toc-section-number">6.1</span> Modification of the <code>fortran</code> sources</a></li>
<li><a href="#modification-of-the-mfront-wrapper"><span class="toc-section-number">6.2</span> Modification of the <code>MFront</code> wrapper</a></li>
</ul></li>
<li><a href="#introducing-the-wrapped-implementation-in-mfrontgallery"><span class="toc-section-number">7</span> Introducing the wrapped implementation in <code>MFrontGallery</code></a>
<ul>
<li><a href="#the-mfrontuserwrapper.hxx-header"><span class="toc-section-number">7.1</span> The <code>MFrontUserWrapper.hxx</code> header</a></li>
<li><a href="#building-the-libraries"><span class="toc-section-number">7.2</span> Building the libraries</a></li>
</ul></li>
<li><a href="#appendix"><span class="toc-section-number">8</span> Appendix</a>
<ul>
<li><a href="#sec:umat_wrapper:umat_source_code"><span class="toc-section-number">8.1</span> Source code of the <code>UMAT</code> subroutine</a></li>
<li><a href="#sec:umat_wrapper:umat2_source_code"><span class="toc-section-number">8.2</span> Source code of the <code>umat2</code> subroutine in <code>Fortran 2003</code></a></li>
</ul></li>
<li><a href="#references">References</a></li>
</ul>
</div>
<!--
pandoc --pdf-engine=xelatex -f markdown --csl=iso690-numeric-en.csl  --bibliography=bibliography.bib --filter pandoc-crossref --citeproc -V geometry:a4paper,margin=2cm --highlight-style=tango --number-sections --variable urlcolor=blue --toc SmallStrainUmatWrapper.md -o SmallStrainUmatWrapper.pdf

# Introduction
-->
<p>Implementing a constitutive model is a long tedious and error-prone process, in particular for soils where a wide variety of phenomena must be taken into account. Moreover, the implementation must satisfy the interface requirements of the targeted solver.</p>
<p>While <code>MFront</code> greatly reduces the amount of work required to implement a new behaviour, existing legacy implementations are highly valuable and their re-implementation in <code>MFront</code> should only be considered with caution considering the trade-offs. In our experience, such a re-implementation increases the maintainability and portability, and generally the numerical performances, but requires significant development efforts.</p>
<p>In this work, we developed an alternative approach, which consists in using <code>MFront</code> as a wrapper to the legacy implementations written using the <code>UMAT</code> interface introduced by the <code>Abaqus/Standard</code> finite element solver.</p>
<figure>
<img src="img/SmallStrainUmatWrapper/mfront-wrapper.svg" id="fig:umat_wrapper:workflow" style="width:90.0%" alt="Figure 1: Workflow for wrapping legacy model implementations in MFront" /><figcaption aria-hidden="true">Figure 1: Workflow for wrapping legacy model implementations in <code>MFront</code></figcaption>
</figure>
<p>The <code>MFront</code> wrapper:</p>
<ul>
<li>handles the transfer of the data from solver to the legacy implementation on input and output as illustrated in Figure 1.</li>
<li>the definition of appropriate metadata which considerably simplifies the behaviour integration in the solver, in particular if the <a href="https://thelfer.github.io/mgis/web/index.html"><code>MFrontGenericInterfaceSupport</code> library</a> (<code>MGIS</code>) is used by the targeted solver <span class="citation" data-cites="Helfer2020 cea_mgis_2021">[<a href="#ref-Helfer2020" role="doc-biblioref">1</a>, <a href="#ref-cea_mgis_2021" role="doc-biblioref">2</a>]</span>.</li>
</ul>
<!--
The latest version of this document can be found here:
<https://thelfer.github.io/MFrontGallery/web/SmallStrainUmatWrapper.html>.
-->
<h1 data-number="1" id="description-of-the-wrapped-umat-implementation-and-role-of-the-wrapper"><span class="header-section-number">1</span> Description of the wrapped <code>UMAT</code> implementation and role of the wrapper</h1>
<p>In this tutorial, we use a sightly modified version of the <code>umat.f</code> file delivered with the <code>CalculiX</code> finite element solver which implements an isotropic elastic behaviour in <code>3D</code>. This implementation is reported in Listing 2 of Appendix 8.1.</p>
<p>This implementation is written in <code>Fortran 77</code> which may lead to a portability issue as the name of the resulting function is implementation defined. We will discard this issue for the moment and come by to it later by rewritting this function in <code>Fortran 95</code> using the <code>BIND(C)</code> attribute in Section 6.</p>
<p>This implementation has no state variables and requires two material properties: the Young’ modulus and the Poisson’ ratio.</p>
<p>The number of arguments effectively used by the subroutine is here very small compared to the total number of arguments:</p>
<ul>
<li><code>stress</code>: an array containing the values of the stress at the beginning of the time step on input and the values of the stress at the end of the time step on output.</li>
<li><code>ddsdde</code>: an array containing the values of the consistent tangent operator on output. As the behaviour is linear elastic, the consistent tangent operator is simply the stiffness matrix.</li>
<li><code>stran</code>: an array containing the values of the strain at the beginning of the time step.</li>
<li><code>dstran</code>: an array containing the values of the strain increment during the time step.</li>
<li><code>props</code>: an array containing the material properties.</li>
</ul>
<p>It is important to note that this implementation does not make any check of its arguments. For example, the user may pass any number of material properties, which may lead to segmentation faults at best or to spurious results difficult to debug at worse. It is interesting to note that <code>MFront</code> will ensure the correct usage of the wrapped behaviour and automatically generate the correct checks.</p>
<p>The <code>UMAT</code> interface uses the so-called Voigt conventions to store symmetric tensors as vectors. <code>MFront</code> uses a different convention, as described in <a href="https://thelfer.github.io/tfel/web/tensors.html">its documentation</a> <span class="citation" data-cites="cea_edf_tfel_tensors_2021">[<a href="#ref-cea_edf_tfel_tensors_2021" role="doc-biblioref">3</a>]</span>. Conversion functions are thus required on input and output of the <code>UMAT</code> implementation.</p>
<p>Special care must also be taken regarding the consistent tangent operator. Not only shall the difference of conventions be taken into account, but also the fact that <code>fortran</code> uses a column-major convention to store matrices while the <code>TFEL/Math</code> library uses a row-major convention. Basically, this means that the consistent tangent operator must transposed. In the case of linear elasticity, the stiffness matrix is obviously symmetric, but this is not the general case.</p>
<p>In this case, the wrapper shall:</p>
<ol type="1">
<li>convert the strain, the strain increment and stress tensors on input</li>
<li>pass the material properties on input.</li>
<li>convert the stress tensor and the stiffness matrix on output.</li>
</ol>
<p>The conversion functions required by Steps 1 and 3 will be the same for all wrappers of <code>UMAT</code> implementations. Moreover, the same conversion functions could also be used when wrapping <code>VUMAT</code> behaviours used by <code>Abaqus/Explicit</code>. It is then convenient to implement them in a dedicated header file, called <code>MFrontUmatWrapper.hxx</code> in the following, using <code>C++</code> template functions. This header is described in Section 2.</p>
<p>Step 2 is a bit more interesting to discuss as it exposes important design choices, as discussed in Section 3.</p>
<h1 data-number="2" id="sec:umat_wrapper:MFrontUmatWrapper"><span class="header-section-number">2</span> Description of the <code>MFrontUmatWrapper.hxx</code> header file</h1>
<p>The <code>MFrontUmatWrapper.hxx</code> header file defines conversion functions that can be used by any <code>UMAT</code> and <code>VUMAT</code> wrappers to convert stress, strain and consistent tangent operators.</p>
<ul>
<li><code>convertStrainToAbaqus</code>, which computes the strain tensor using <code>̀UMAT</code> conventions from the <code>MFront</code> strain tensor. This function can also be used for the strain increment tensor.</li>
<li><code>convertStressToAbaqus</code>, which computes the stress tensor using <code>̀UMAT</code> conventions from the <code>MFront</code> stress tensor.</li>
<li><code>convertStressFromAbaqus</code>, which computes the <code>MFront</code> stress tensor from the <code>UMAT</code> result.</li>
<li><code>convertStiffnessMatrixFromAbaqus</code>, which computes the <code>MFront</code> stiffness matrix for the <code>UMAT</code> result.</li>
</ul>
<p>To avoid runtime checks, those functions use a the modelling hypothesis as a first template parameter. We use here the fact that <code>MFront</code>’ behaviours are also templated by the modelling hypothesis, which is then known at compile-time.</p>
<p>Since <code>Abaqus/Explicit</code> handles computations in simple and double precision, the conversion function takes the numeric type as a second template parameter.</p>
<p>All the convertion functions are declared in the <code>mfront_umat_wrapper</code> namespace.</p>
<p>Listing 1 provide an implementation, limited to the tridimensional case, of the <code>convertStrainToAbaqus</code> function.</p>
<div id="lst:umat_wrapper:convertStrainToAbaqus" class="listing cxx">
<p>Listing 1: Source code of the `convertStrainToAbaqus` function</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode cxx"><code class="sourceCode cpp"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a>  <span class="kw">template</span> &lt;Hypothesis H, <span class="kw">typename</span> NumType&gt;</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">void</span> convertStrainToAbaqus(AbaqusRealType *<span class="at">const</span> e,</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>                             <span class="at">const</span> NumType *<span class="at">const</span> strain) {</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">constexpr</span> (H == Hypothesis::TRIDIMENSIONAL) {</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>      <span class="kw">constexpr</span> <span class="kw">auto</span> cste = tfel::math::Cste&lt;NumType&gt;::sqrt2;</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>      e[<span class="dv">0</span>] = strain[<span class="dv">0</span>];</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>      e[<span class="dv">1</span>] = strain[<span class="dv">1</span>];</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>      e[<span class="dv">2</span>] = strain[<span class="dv">2</span>];</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>      e[<span class="dv">3</span>] = strain[<span class="dv">3</span>] * cste;</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>      e[<span class="dv">4</span>] = strain[<span class="dv">4</span>] * cste;</span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a>      e[<span class="dv">5</span>] = strain[<span class="dv">5</span>] * cste;</span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a>      tfel::raise(<span class="st">&quot;Unsupported hypothesis&quot;</span>);</span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a>  }  <span class="co">// end of convertStrainToAbaqus</span></span></code></pre></div>
</div>
<h1 data-number="3" id="sec:umat_wrapper:material_properties"><span class="header-section-number">3</span> Treatment of the material properties</h1>
<p>The treatment of the material properties deserves a special discussion.</p>
<p>The first choice that one has to make is whether the final behaviour shall be specific to a given material and self-contained or be generic. You may refer to the <a href="index.html">front page</a> of the project for a detailled discussion about those concepts.</p>
<p>Of course, in the case of the simple example treated in this document, this kind of considerations seems largely overkill. For the sake of the discussion, let us however pretend that we are considering an non trivial <code>UMAT</code> behaviour.</p>
<h2 data-number="3.1" id="the-generic-behaviour-case"><span class="header-section-number">3.1</span> The generic behaviour case</h2>
<p>Material properties, introduced by the <code>@MaterialProperty</code> keyword, imposes that the solver provides the required material coefficients.</p>
<p>For the sake of simplicity, we choose that the <code>MFront</code> behaviour require the same material properties than the <code>UMAT</code> implementation, i.e. the Young’ modulus and the Poisson’ ratio. But other choices could have been discussed and we could have chosen another pair of elastic properties, for example the Lamé’ coefficients: with such a choice, the wrapper then would need to compute the Young’ modulus and the Poisson’ ratio before calling the <code>UMAT</code> behaviour.</p>
<p>Another choice now have to be made: shall we declare an array of material properties or shall we declare two distinct material properties ? As usual, each solution have drawbacks and avantages, as now discussed.</p>
<h3 data-number="3.1.1" id="declaring-an-array-of-material-properties"><span class="header-section-number">3.1.1</span> Declaring an array of material properties</h3>
<p>Declaring an array of material properties has one pratical advantage as it already meets the requirements that the material properties shall be stored in a continuous array.</p>
<p>This array of material properties could be declared as follows:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode cxx"><code class="sourceCode cpp"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="co">//! elastic material properties</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="er">@</span>MaterialProperty real emps[<span class="dv">2</span>];</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>emps.setEntryName(<span class="st">&quot;ElasticProperties&quot;</span>);</span></code></pre></div>
<p>Before calling the <code>UMAT</code> implementation, a pointer to the beginning of the array can be retrieved as follows:</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode cxx"><code class="sourceCode cpp"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="at">const</span> <span class="kw">auto</span>* <span class="at">const</span> props = emps.data();</span></code></pre></div>
<p>From the point of view of the developper of the <code>MFront</code> wrapper, this may seem very convenient and straightforward.</p>
<p>However, from the end-user point of view, this solution may seem less attractive. In particular, if the solver that he uses relies on the metadata exported by <code>MFront</code>, it will require the end-user to define two material properties named respectively <code>ElasticProperties[0]</code> and <code>ElasticProperties[1]</code>. One may agree that those names are not very explicit.</p>
<p>Of course, this seems articifial when considering only two material properties, but this may not be as evident for complex behaviours requiring several dozen of material properties as the amount of work required to develop the wrapper increases. This remark can be directly transposed to internal state variables, if any.</p>
<h3 data-number="3.1.2" id="declaring-two-distinct-material-properties"><span class="header-section-number">3.1.2</span> Declaring two distinct material properties</h3>
<p>The Young’ modulus and the Poisson’ ratio can be declared as follows:</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode cxx"><code class="sourceCode cpp"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="er">@</span>MaterialProperty stress E;</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>E.setGlossaryName(<span class="st">&quot;YoungModulus&quot;</span>);</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a><span class="er">@</span>MaterialProperty real nu;</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>nu.setGlossaryName(<span class="st">&quot;PoissonRatio&quot;</span>);</span></code></pre></div>
<p>This is more explicit and potentially more attractive for the end-user if the solver that he uses relies on the metadata exported by <code>MFront</code>.</p>
<p>Before calling the <code>UMAT</code> implementation, one shall create an array of floating-point values and initialize its values as follows:</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode cxx"><code class="sourceCode cpp"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="at">const</span> real props[<span class="dv">2</span>] = {E,nu};</span></code></pre></div>
<p>Again, this is straightforward when only two material properties are considered, but the effort grows significantly as the number of material properties increases.</p>
<blockquote>
<p><strong>About the usage of quantities</strong></p>
<p>One may notice that we have declared the Young’ modulus as a variable of type <code>stress</code>. This is only informative as long as support for quantities has not been enabled (using the <code>@UseQt</code> keyword).</p>
<p>It is highly discouraged to enable support for quantities when creating a wrapper as it generates an extra layer of complexity for an <em>a priori</em> doubtful gain.</p>
</blockquote>
<h2 data-number="3.2" id="the-self-contained-case"><span class="header-section-number">3.2</span> The self-contained case</h2>
<p>Various approaches may be followed to implement a self-contained behaviour. The most standard is to use parameters. Again, one have the choice between using an array of parameters or two distinct parameters with similar advantages and drawbacks.</p>
<h1 data-number="4" id="implementation-of-the-umat-wrapper-in-mfront"><span class="header-section-number">4</span> Implementation of the <code>UMAT</code> wrapper in <code>MFront</code></h1>
<h2 data-number="4.1" id="a-quick-overview-of-fortran-77c-interoperability"><span class="header-section-number">4.1</span> A quick overview of <code>fortran 77</code>/<code>C++</code> interoperability</h2>
<p>The <code>umat</code> function has the following prototype in <code>fortran</code> (see Appendix 8.1):</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode fortran"><code class="sourceCode fortranfixed"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="bu">     s</span>ubroutine umat(stress,statev,ddsdde,sse,spd,scd,</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a><span class="bu">     &amp;</span>  rpl,ddsddt,drplde,drpldt,</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a><span class="bu">     &amp;</span>  stran,dstran,time,dtime,temp,dtemp,predef,dpred,cmname,</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a><span class="bu">     &amp;</span>  ndi,nshr,ntens,nstatv,props,nprops,coords,drot,pnewdt,</span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a><span class="bu">     &amp;</span>  celent,dfgrd0,dfgrd1,noel,npt,layer,kspt,kstep,kinc)</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a><span class="co">!</span></span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>      <span class="kw">implicit</span> <span class="kw">none</span></span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a><span class="co">!</span></span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a>      <span class="dt">character*80</span> cmname</span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a><span class="co">!</span></span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a>      <span class="dt">integer</span> ndi,nshr,ntens,nstatv,nprops,noel,npt,layer,kspt,</span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a><span class="bu">     &amp;</span>  kstep,kinc</span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a><span class="co">!</span></span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a>      <span class="dt">real*8</span> stress(ntens),statev(nstatv),</span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true" tabindex="-1"></a><span class="bu">     &amp;</span>  ddsdde(ntens,ntens),ddsddt(ntens),drplde(ntens),</span>
<span id="cb6-16"><a href="#cb6-16" aria-hidden="true" tabindex="-1"></a><span class="bu">     &amp;</span>  stran(ntens),dstran(ntens),time(<span class="dv">2</span>),celent,</span>
<span id="cb6-17"><a href="#cb6-17" aria-hidden="true" tabindex="-1"></a><span class="bu">     &amp;</span>  props(nprops),coords(<span class="dv">3</span>),drot(<span class="dv">3</span>,<span class="dv">3</span>),dfgrd0(<span class="dv">3</span>,<span class="dv">3</span>),dfgrd1(<span class="dv">3</span>,<span class="dv">3</span>),</span>
<span id="cb6-18"><a href="#cb6-18" aria-hidden="true" tabindex="-1"></a><span class="bu">     &amp;</span>  sse,spd,scd,rpl,drpldt,dtime,temp,dtemp,predef,dpred,</span>
<span id="cb6-19"><a href="#cb6-19" aria-hidden="true" tabindex="-1"></a><span class="bu">     &amp;</span>  pnewdt</span></code></pre></div>
<p>This prototype is equivalent to the following <code>C</code> declaration:</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode cxx"><code class="sourceCode cpp"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> <span class="va">umat_</span>(</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>    <span class="dt">double</span> *<span class="at">const</span>,       <span class="co">/*&lt; STRESS, stress                   */</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>    <span class="dt">double</span> *<span class="at">const</span>,       <span class="co">/*&lt; STATEV, internal state variables */</span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>    <span class="dt">double</span> *<span class="at">const</span>,       <span class="co">/*&lt; DDSDDE, tangent operator         */</span></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>    <span class="dt">double</span> *<span class="at">const</span>,       <span class="co">/*&lt; SSE */</span></span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>    <span class="dt">double</span> *<span class="at">const</span>,       <span class="co">/*&lt; SPD */</span></span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>    <span class="dt">double</span> *<span class="at">const</span>,       <span class="co">/*&lt; SCD */</span></span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>    <span class="dt">double</span> *<span class="at">const</span>,       <span class="co">/*&lt; RPL */</span></span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>    <span class="dt">double</span> *<span class="at">const</span>,       <span class="co">/*&lt; DDSDDT */</span></span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a>    <span class="dt">double</span> *<span class="at">const</span>,       <span class="co">/*&lt; DRPLDE */</span></span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a>    <span class="dt">double</span> *<span class="at">const</span>,       <span class="co">/*&lt; DRPLDT */</span></span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">const</span> <span class="dt">double</span> *<span class="at">const</span>, <span class="co">/*&lt; STRAN, strain tensor    */</span></span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">const</span> <span class="dt">double</span> *<span class="at">const</span>, <span class="co">/*&lt; DSTRAN, strain increment */</span></span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">const</span> <span class="dt">double</span> *<span class="at">const</span>, <span class="co">/*&lt; TIME */</span></span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">const</span> <span class="dt">double</span> *<span class="at">const</span>, <span class="co">/*&lt; DTIME, time increment   */</span></span>
<span id="cb7-16"><a href="#cb7-16" aria-hidden="true" tabindex="-1"></a>    <span class="at">const</span> <span class="dt">double</span> *<span class="at">const</span>, <span class="co">/*&lt; TEMP, temperature      */</span></span>
<span id="cb7-17"><a href="#cb7-17" aria-hidden="true" tabindex="-1"></a>    <span class="at">const</span> <span class="dt">double</span> *<span class="at">const</span>, <span class="co">/*&lt; DTEMP, temperature increment    */</span></span>
<span id="cb7-18"><a href="#cb7-18" aria-hidden="true" tabindex="-1"></a>    <span class="at">const</span> <span class="dt">double</span> *<span class="at">const</span>, <span class="co">/*&lt; PREDEF, external state variables */</span></span>
<span id="cb7-19"><a href="#cb7-19" aria-hidden="true" tabindex="-1"></a>    <span class="at">const</span> <span class="dt">double</span> *<span class="at">const</span>, <span class="co">/*&lt; DPRED, external state variables increments   */</span></span>
<span id="cb7-20"><a href="#cb7-20" aria-hidden="true" tabindex="-1"></a>    <span class="at">const</span> <span class="dt">char</span> *<span class="at">const</span>,   <span class="co">/*&lt; CMNAME */</span></span>
<span id="cb7-21"><a href="#cb7-21" aria-hidden="true" tabindex="-1"></a>    <span class="at">const</span> <span class="dt">int</span> *<span class="at">const</span>,    <span class="co">/*&lt; NDI */</span></span>
<span id="cb7-22"><a href="#cb7-22" aria-hidden="true" tabindex="-1"></a>    <span class="at">const</span> <span class="dt">int</span> *<span class="at">const</span>,    <span class="co">/*&lt; NSHR */</span></span>
<span id="cb7-23"><a href="#cb7-23" aria-hidden="true" tabindex="-1"></a>    <span class="at">const</span> <span class="dt">int</span> *<span class="at">const</span>,    <span class="co">/*&lt; NTENS, number of components of tensors */</span></span>
<span id="cb7-24"><a href="#cb7-24" aria-hidden="true" tabindex="-1"></a>    <span class="at">const</span> <span class="dt">int</span> *<span class="at">const</span>,    <span class="co">/*&lt; NSTATV, number of internal state variables */</span></span>
<span id="cb7-25"><a href="#cb7-25" aria-hidden="true" tabindex="-1"></a>    <span class="at">const</span> <span class="dt">double</span> *<span class="at">const</span>, <span class="co">/*&lt; PROPS, material properties */</span></span>
<span id="cb7-26"><a href="#cb7-26" aria-hidden="true" tabindex="-1"></a>    <span class="at">const</span> <span class="dt">int</span> *<span class="at">const</span>,    <span class="co">/*&lt; NPROPS, number of material properties */</span></span>
<span id="cb7-27"><a href="#cb7-27" aria-hidden="true" tabindex="-1"></a>    <span class="at">const</span> <span class="dt">double</span> *<span class="at">const</span>, <span class="co">/*&lt; COORDS */</span></span>
<span id="cb7-28"><a href="#cb7-28" aria-hidden="true" tabindex="-1"></a>    <span class="at">const</span> <span class="dt">double</span> *<span class="at">const</span>, <span class="co">/*&lt; DROT, incremental rotation matrix */</span></span>
<span id="cb7-29"><a href="#cb7-29" aria-hidden="true" tabindex="-1"></a>    <span class="at">const</span> <span class="dt">double</span> *<span class="at">const</span>, <span class="co">/*&lt; PNEWDT, estimation of the next time increment */</span></span>
<span id="cb7-30"><a href="#cb7-30" aria-hidden="true" tabindex="-1"></a>    <span class="at">const</span> <span class="dt">double</span> *<span class="at">const</span>, <span class="co">/*&lt; CELENT */</span></span>
<span id="cb7-31"><a href="#cb7-31" aria-hidden="true" tabindex="-1"></a>    <span class="at">const</span> <span class="dt">double</span> *<span class="at">const</span>, <span class="co">/*&lt; DFGRD0 */</span></span>
<span id="cb7-32"><a href="#cb7-32" aria-hidden="true" tabindex="-1"></a>    <span class="at">const</span> <span class="dt">double</span> *<span class="at">const</span>, <span class="co">/*&lt; DFGRD1 */</span></span>
<span id="cb7-33"><a href="#cb7-33" aria-hidden="true" tabindex="-1"></a>    <span class="at">const</span> <span class="dt">int</span> *<span class="at">const</span>,    <span class="co">/*&lt; NOEL */</span></span>
<span id="cb7-34"><a href="#cb7-34" aria-hidden="true" tabindex="-1"></a>    <span class="at">const</span> <span class="dt">int</span> *<span class="at">const</span>,    <span class="co">/*&lt; NPT */</span></span>
<span id="cb7-35"><a href="#cb7-35" aria-hidden="true" tabindex="-1"></a>    <span class="at">const</span> <span class="dt">int</span> *<span class="at">const</span>,    <span class="co">/*&lt; LAYER */</span></span>
<span id="cb7-36"><a href="#cb7-36" aria-hidden="true" tabindex="-1"></a>    <span class="at">const</span> <span class="dt">int</span> *<span class="at">const</span>,    <span class="co">/*&lt; KSPT */</span></span>
<span id="cb7-37"><a href="#cb7-37" aria-hidden="true" tabindex="-1"></a>    <span class="at">const</span> <span class="dt">int</span> *<span class="at">const</span>,    <span class="co">/*&lt; KSTEP */</span></span>
<span id="cb7-38"><a href="#cb7-38" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> *<span class="at">const</span>,          <span class="co">/*&lt; KINC */</span></span>
<span id="cb7-39"><a href="#cb7-39" aria-hidden="true" tabindex="-1"></a>    <span class="at">const</span> <span class="dt">int</span> <span class="co">/* hidden fortran parameter */</span>);</span>
<span id="cb7-40"><a href="#cb7-40" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>Note that the name chosen for this function follows <code>gfortan</code>’ mangling scheme for fortran functions, i.e. the <code>fortran</code> <code>umat</code> function is exported as <code>umat_</code>. This is not portable. So is the type of the hidden parameter holding the size of the <code>CMNAME</code> parameter.</p>
<p>For real world use, we strongly advice to either:</p>
<ul>
<li>modify the wrapped function and rewrite it in <code>Fortran 2003</code>.</li>
<li>create an intermediate <code>fortran</code> function with proper <code>C</code> bindings.</li>
</ul>
<p>In both cases, we also stronly advice to remove useless parameters.</p>
<p>We do not do this in this tutorial at this stage for the sake of generality and will show a more satisfying solution in Section 6.</p>
<p>One shall not that all parameters are passed as pointers, except the hidden fortran parameter.</p>
<h2 data-number="4.2" id="choice-of-the-domain-specific-languagemfront"><span class="header-section-number">4.2</span> Choice of the domain specific language<code>MFront</code></h2>
<div class="sourceCode" id="cb8"><pre class="sourceCode cxx"><code class="sourceCode cpp"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="er">@</span>DSL Default;</span></code></pre></div>
<h2 data-number="4.3" id="some-metadata"><span class="header-section-number">4.3</span> Some metadata</h2>
<div class="sourceCode" id="cb9"><pre class="sourceCode cxx"><code class="sourceCode cpp"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="er">@</span>Behaviour SmallStrainUmatWrapper;</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a><span class="er">@</span>Author Thomas Helfer;</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a><span class="er">@</span>Date <span class="dv">11</span> / <span class="bn">02</span> / <span class="dv">2021</span>;</span></code></pre></div>
<h2 data-number="4.4" id="restricting-the-allowed-modelling-hypothesis"><span class="header-section-number">4.4</span> Restricting the allowed modelling hypothesis</h2>
<p>The conversion functions are limited to the tridimensional modelling hypothesis. Trying to use them with another modelling hypothesis would result in a compile-time error.</p>
<p>The <code>@ModellingHypothesis</code> keyword allows to only generate the tridimensional version of this behaviour:</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode cxx"><code class="sourceCode cpp"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="er">@</span>ModellingHypothesis Tridimensional;</span></code></pre></div>
<h2 data-number="4.5" id="including-the-mfrontumatwrapper-file"><span class="header-section-number">4.5</span> Including the <code>MFrontUmatWrapper</code> file</h2>
<p>The <code>@Includes</code> code block can be use to include the <code>MFrontUmatWrapper.hxx</code> header and declare the <code>umat_</code> function as follows:</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode cxx"><code class="sourceCode cpp"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="er">@</span>Includes {</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&quot;MFrontUmatWrapper.hxx&quot;</span></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a><span class="pp">#ifndef MFRONT_UMAT_FUNCTION_DECLARATION</span></span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a><span class="pp">#define MFRONT_UMAT_FUNCTION_DECLARATION </span><span class="dv">1</span></span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a><span class="at">extern</span> <span class="st">&quot;C&quot;</span> {</span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> <span class="va">umat_</span>(</span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a>    AbaqusRealType *<span class="at">const</span> <span class="co">/* STRESS */</span>, <span class="co">/* stress                   */</span></span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a>    AbaqusRealType *<span class="at">const</span> <span class="co">/* STATEV */</span>, <span class="co">/* internal state variables */</span></span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a>    AbaqusRealType *<span class="at">const</span> <span class="co">/* DDSDDE */</span>, <span class="co">/* tangent operator         */</span></span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a>    AbaqusRealType *<span class="at">const</span> <span class="co">/* SSE */</span>,</span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true" tabindex="-1"></a>    AbaqusRealType *<span class="at">const</span> <span class="co">/* SPD */</span>,</span>
<span id="cb11-14"><a href="#cb11-14" aria-hidden="true" tabindex="-1"></a>    AbaqusRealType *<span class="at">const</span> <span class="co">/* SCD */</span>,</span>
<span id="cb11-15"><a href="#cb11-15" aria-hidden="true" tabindex="-1"></a>    AbaqusRealType *<span class="at">const</span> <span class="co">/* RPL */</span>,</span>
<span id="cb11-16"><a href="#cb11-16" aria-hidden="true" tabindex="-1"></a>    AbaqusRealType *<span class="at">const</span> <span class="co">/* DDSDDT */</span>,</span>
<span id="cb11-17"><a href="#cb11-17" aria-hidden="true" tabindex="-1"></a>    AbaqusRealType *<span class="at">const</span> <span class="co">/* DRPLDE */</span>,</span>
<span id="cb11-18"><a href="#cb11-18" aria-hidden="true" tabindex="-1"></a>    AbaqusRealType *<span class="at">const</span> <span class="co">/* DRPLDT */</span>,</span>
<span id="cb11-19"><a href="#cb11-19" aria-hidden="true" tabindex="-1"></a>    <span class="at">const</span> AbaqusRealType *<span class="at">const</span> <span class="co">/* STRAN */</span>,  <span class="co">/* strain tensor    */</span></span>
<span id="cb11-20"><a href="#cb11-20" aria-hidden="true" tabindex="-1"></a>    <span class="at">const</span> AbaqusRealType *<span class="at">const</span> <span class="co">/* DSTRAN */</span>, <span class="co">/* strain increment */</span></span>
<span id="cb11-21"><a href="#cb11-21" aria-hidden="true" tabindex="-1"></a>    <span class="at">const</span> AbaqusRealType *<span class="at">const</span> <span class="co">/* TIME */</span>,</span>
<span id="cb11-22"><a href="#cb11-22" aria-hidden="true" tabindex="-1"></a>    <span class="at">const</span> AbaqusRealType *<span class="at">const</span> <span class="co">/* DTIME */</span>,  <span class="co">/* time increment   */</span></span>
<span id="cb11-23"><a href="#cb11-23" aria-hidden="true" tabindex="-1"></a>    <span class="at">const</span> AbaqusRealType *<span class="at">const</span> <span class="co">/* TEMP */</span>,   <span class="co">/* temperature      */</span></span>
<span id="cb11-24"><a href="#cb11-24" aria-hidden="true" tabindex="-1"></a>    <span class="at">const</span> AbaqusRealType *<span class="at">const</span> <span class="co">/* DTEMP */</span>,  <span class="co">/* temperature increment    */</span></span>
<span id="cb11-25"><a href="#cb11-25" aria-hidden="true" tabindex="-1"></a>    <span class="at">const</span> AbaqusRealType *<span class="at">const</span> <span class="co">/* PREDEF */</span>, <span class="co">/* external state variables */</span></span>
<span id="cb11-26"><a href="#cb11-26" aria-hidden="true" tabindex="-1"></a>    <span class="at">const</span> AbaqusRealType *<span class="at">const</span> <span class="co">/* DPRED */</span>, <span class="co">/* external state variables increments   */</span></span>
<span id="cb11-27"><a href="#cb11-27" aria-hidden="true" tabindex="-1"></a>    <span class="at">const</span> <span class="dt">char</span> *<span class="at">const</span> <span class="co">/* CMNAME */</span>,</span>
<span id="cb11-28"><a href="#cb11-28" aria-hidden="true" tabindex="-1"></a>    <span class="at">const</span> AbaqusIntegerType *<span class="at">const</span> <span class="co">/* NDI */</span>,</span>
<span id="cb11-29"><a href="#cb11-29" aria-hidden="true" tabindex="-1"></a>    <span class="at">const</span> AbaqusIntegerType *<span class="at">const</span> <span class="co">/* NSHR */</span>,</span>
<span id="cb11-30"><a href="#cb11-30" aria-hidden="true" tabindex="-1"></a>    <span class="at">const</span> AbaqusIntegerType *<span class="at">const</span> <span class="co">/* NTENS */</span>, <span class="co">/* number of components of tensors */</span></span>
<span id="cb11-31"><a href="#cb11-31" aria-hidden="true" tabindex="-1"></a>    <span class="at">const</span> AbaqusIntegerType *<span class="at">const</span> <span class="co">/* NSTATV */</span>, <span class="co">/* number of internal state variables */</span></span>
<span id="cb11-32"><a href="#cb11-32" aria-hidden="true" tabindex="-1"></a>    <span class="at">const</span> AbaqusRealType *<span class="at">const</span> <span class="co">/* PROPS */</span>, <span class="co">/* material properties */</span></span>
<span id="cb11-33"><a href="#cb11-33" aria-hidden="true" tabindex="-1"></a>    <span class="at">const</span> AbaqusIntegerType *<span class="at">const</span> <span class="co">/* NPROPS */</span>, <span class="co">/* number of material properties */</span></span>
<span id="cb11-34"><a href="#cb11-34" aria-hidden="true" tabindex="-1"></a>    <span class="at">const</span> AbaqusRealType *<span class="at">const</span> <span class="co">/* COORDS */</span>,</span>
<span id="cb11-35"><a href="#cb11-35" aria-hidden="true" tabindex="-1"></a>    <span class="at">const</span> AbaqusRealType *<span class="at">const</span> <span class="co">/* DROT, incremental rotation matrix */</span>,</span>
<span id="cb11-36"><a href="#cb11-36" aria-hidden="true" tabindex="-1"></a>    <span class="at">const</span> AbaqusRealType *<span class="at">const</span> <span class="co">/* PNEWDT, estimation of the next time increment */</span>,</span>
<span id="cb11-37"><a href="#cb11-37" aria-hidden="true" tabindex="-1"></a>    <span class="at">const</span> AbaqusRealType *<span class="at">const</span> <span class="co">/* CELENT */</span>,</span>
<span id="cb11-38"><a href="#cb11-38" aria-hidden="true" tabindex="-1"></a>    <span class="at">const</span> AbaqusRealType *<span class="at">const</span> <span class="co">/* DFGRD0 */</span>,</span>
<span id="cb11-39"><a href="#cb11-39" aria-hidden="true" tabindex="-1"></a>    <span class="at">const</span> AbaqusRealType *<span class="at">const</span> <span class="co">/* DFGRD1 */</span>,</span>
<span id="cb11-40"><a href="#cb11-40" aria-hidden="true" tabindex="-1"></a>    <span class="at">const</span> AbaqusIntegerType *<span class="at">const</span> <span class="co">/* NOEL */</span>,</span>
<span id="cb11-41"><a href="#cb11-41" aria-hidden="true" tabindex="-1"></a>    <span class="at">const</span> AbaqusIntegerType *<span class="at">const</span> <span class="co">/* NPT */</span>,</span>
<span id="cb11-42"><a href="#cb11-42" aria-hidden="true" tabindex="-1"></a>    <span class="at">const</span> AbaqusIntegerType *<span class="at">const</span> <span class="co">/* LAYER */</span>,</span>
<span id="cb11-43"><a href="#cb11-43" aria-hidden="true" tabindex="-1"></a>    <span class="at">const</span> AbaqusIntegerType *<span class="at">const</span> <span class="co">/* KSPT */</span>,</span>
<span id="cb11-44"><a href="#cb11-44" aria-hidden="true" tabindex="-1"></a>    <span class="at">const</span> AbaqusIntegerType *<span class="at">const</span> <span class="co">/* KSTEP */</span>,</span>
<span id="cb11-45"><a href="#cb11-45" aria-hidden="true" tabindex="-1"></a>    AbaqusIntegerType *<span class="at">const</span> <span class="co">/* KINC */</span>,</span>
<span id="cb11-46"><a href="#cb11-46" aria-hidden="true" tabindex="-1"></a>    <span class="at">const</span> <span class="dt">int</span> <span class="co">/* hidden fortran parameter */</span>);</span>
<span id="cb11-47"><a href="#cb11-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-48"><a href="#cb11-48" aria-hidden="true" tabindex="-1"></a>} <span class="co">// end of extern &quot;C&quot;</span></span>
<span id="cb11-49"><a href="#cb11-49" aria-hidden="true" tabindex="-1"></a><span class="pp">#endif </span><span class="er">MFRONT_UMAT_FUNCTION_DECLARATION 1</span></span>
<span id="cb11-50"><a href="#cb11-50" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>In the <code>umat_</code> function declaration, we used to type aliases, <code>AbaqusIntegerType</code> and <code>AbaqusRealType</code>, which is usually a good practice. Here, we recognize that this is a bit overkill, if not pedantic.</p>
<h2 data-number="4.6" id="elastic-properties"><span class="header-section-number">4.6</span> Elastic properties</h2>
<p>Following the discussion of Section 3, we choose here to declare two distincts material properties:</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode cxx"><code class="sourceCode cpp"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="er">@</span>MaterialProperty stress E;</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>E.setGlossaryName(<span class="st">&quot;YoungModulus&quot;</span>);</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a><span class="er">@</span>MaterialProperty real nu;</span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>nu.setGlossaryName(<span class="st">&quot;PoissonRatio&quot;</span>);</span></code></pre></div>
<h2 data-number="4.7" id="local-variable"><span class="header-section-number">4.7</span> Local variable</h2>
<p>In our implementation, it will be usefull to store the values of the consistent tangent operator computed by the <code>UMAT</code> implementation in a local variable, as discussed in Section 4.9.</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode cxx"><code class="sourceCode cpp"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="er">@</span>LocalVariable StiffnessTensor K;</span></code></pre></div>
<h2 data-number="4.8" id="implementation-of-the-behaviour-integration"><span class="header-section-number">4.8</span> Implementation of the behaviour integration</h2>
<p>The behaviour integration is performed in the <code>@Integrator</code> code block.</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode cxx"><code class="sourceCode cpp"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="er">@</span>Integrator {</span></code></pre></div>
<p>We first define the <code>̀KINC</code> integer which will hold the returned value of the <code>UMAT</code> implementation. It is initialized to <code>1</code> and is only modified by the <code>UMAT</code> implementation in case of integration failure.</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode cxx"><code class="sourceCode cpp"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>  AbaqusIntegerType KINC = <span class="dv">1</span>;</span></code></pre></div>
<p>We then define a lot of variables which are part of the <code>UMAT</code> interface but unused by the implementation that we are interfacing in this tuturial:</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode cxx"><code class="sourceCode cpp"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>  <span class="co">// unused variables</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">const</span> AbaqusRealType dfgrd0[<span class="dv">9</span>] = {<span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>,  <span class="co">//</span></span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>                                    <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">0</span>,  <span class="co">//</span></span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>                                    <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">1</span>};</span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">const</span> AbaqusRealType dfgrd1[<span class="dv">9</span>] = {<span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>,  <span class="co">//</span></span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a>                                    <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">0</span>,  <span class="co">//</span></span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a>                                    <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">1</span>};</span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">const</span> AbaqusRealType drot[<span class="dv">9</span>] = {<span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">0</span>,  <span class="co">//</span></span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a>                                  <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">0</span>,  <span class="co">//</span></span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a>                                  <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">1</span>};</span>
<span id="cb16-11"><a href="#cb16-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">const</span> AbaqusIntegerType KSTEP[<span class="dv">3</span><span class="bu">u</span>] = {<span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>};</span>
<span id="cb16-12"><a href="#cb16-12" aria-hidden="true" tabindex="-1"></a>  AbaqusRealType sse, spd, scd, rpl;</span>
<span id="cb16-13"><a href="#cb16-13" aria-hidden="true" tabindex="-1"></a>  AbaqusRealType ddsddt[<span class="dv">6</span>];</span>
<span id="cb16-14"><a href="#cb16-14" aria-hidden="true" tabindex="-1"></a>  AbaqusRealType drplde[<span class="dv">6</span>];</span>
<span id="cb16-15"><a href="#cb16-15" aria-hidden="true" tabindex="-1"></a>  AbaqusRealType drpldt;</span>
<span id="cb16-16"><a href="#cb16-16" aria-hidden="true" tabindex="-1"></a>  AbaqusRealType time[<span class="dv">2</span>];</span>
<span id="cb16-17"><a href="#cb16-17" aria-hidden="true" tabindex="-1"></a>  AbaqusRealType pred[<span class="dv">1</span>];</span>
<span id="cb16-18"><a href="#cb16-18" aria-hidden="true" tabindex="-1"></a>  AbaqusRealType dpred[<span class="dv">1</span>];</span>
<span id="cb16-19"><a href="#cb16-19" aria-hidden="true" tabindex="-1"></a>  AbaqusRealType isvs[<span class="dv">1</span>];</span>
<span id="cb16-20"><a href="#cb16-20" aria-hidden="true" tabindex="-1"></a>  AbaqusRealType coords[<span class="dv">3</span>] = {<span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>};</span>
<span id="cb16-21"><a href="#cb16-21" aria-hidden="true" tabindex="-1"></a>  AbaqusRealType celent;</span>
<span id="cb16-22"><a href="#cb16-22" aria-hidden="true" tabindex="-1"></a>  AbaqusRealType rdt;</span>
<span id="cb16-23"><a href="#cb16-23" aria-hidden="true" tabindex="-1"></a>  <span class="at">const</span> <span class="dt">char</span> name[<span class="dv">81</span>] =</span>
<span id="cb16-24"><a href="#cb16-24" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;Elasticity                              &quot;</span>  <span class="co">//</span></span>
<span id="cb16-25"><a href="#cb16-25" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;                                        &quot;</span>;</span>
<span id="cb16-26"><a href="#cb16-26" aria-hidden="true" tabindex="-1"></a>  AbaqusIntegerType layer;</span>
<span id="cb16-27"><a href="#cb16-27" aria-hidden="true" tabindex="-1"></a>  AbaqusIntegerType kspt;</span></code></pre></div>
<p>As those variables are passed by pointers, we could directly pass the null pointers to the <code>UMAT</code> implementation, i.e. the <code>nullptr</code> value. We define those unused variables to facilitate the extension to more complex <code>UMAT</code> implementations.</p>
<p>Note that we define the <code>name</code> variable as an array of 81 characters to take into account the <code>C</code> terminating characters ‘\0.’</p>
<p>The material properties are stored in a temporary array, as follows:</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode cxx"><code class="sourceCode cpp"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="at">const</span> AbaqusRealType props[<span class="dv">2</span>] = {E,nu};</span></code></pre></div>
<p>The next step is to convert the strain, strain increment and stress. We first define the array that will hold the converted values and call the conversion functions.</p>
<div class="sourceCode" id="cb18"><pre class="sourceCode cxx"><code class="sourceCode cpp"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>  AbaqusRealType e[<span class="dv">6</span>];</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>  AbaqusRealType de[<span class="dv">6</span>];</span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>  AbaqusRealType s[<span class="dv">6</span>];</span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a>  mfront_umat_wrapper::convertStrainToAbaqus&lt;hypothesis&gt;(e, &amp;eto[<span class="dv">0</span>]);</span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a>  mfront_umat_wrapper::convertStrainToAbaqus&lt;hypothesis&gt;(de, &amp;deto[<span class="dv">0</span>]);</span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a>  mfront_umat_wrapper::convertStressToAbaqus&lt;hypothesis&gt;(s, &amp;sig[<span class="dv">0</span>]);</span></code></pre></div>
<p>We then define the various integer constants required by the <code>UMAT</code> interface:</p>
<div class="sourceCode" id="cb19"><pre class="sourceCode cxx"><code class="sourceCode cpp"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>  <span class="at">const</span> <span class="kw">auto</span> nprops = <span class="kw">static_cast</span>&lt;AbaqusIntegerType&gt;(<span class="dv">2</span>);</span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">const</span> <span class="kw">auto</span> nstatv = <span class="kw">static_cast</span>&lt;AbaqusIntegerType&gt;(<span class="dv">0</span>);</span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">const</span> <span class="kw">auto</span> ntens = <span class="kw">static_cast</span>&lt;AbaqusIntegerType&gt;(<span class="dv">6</span>);</span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">const</span> <span class="kw">auto</span> ndi = <span class="kw">static_cast</span>&lt;AbaqusIntegerType&gt;(<span class="dv">3</span>);</span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">const</span> <span class="kw">auto</span> nshr = <span class="kw">static_cast</span>&lt;AbaqusIntegerType&gt;(<span class="dv">3</span>);</span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">const</span> <span class="kw">auto</span> noel = <span class="kw">static_cast</span>&lt;AbaqusIntegerType&gt;(<span class="dv">0</span>);</span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">const</span> <span class="kw">auto</span> npt = <span class="kw">static_cast</span>&lt;AbaqusIntegerType&gt;(<span class="dv">0</span>);</span></code></pre></div>
<p>Note that the values of <code>ntens</code> (number of components of the stress tensor), <code>ndi</code> (number of diagonal components of the stress tensor) and <code>nshr</code> (number of shear components of the stress tensor) shall be modified if other modelling hypothesis has to be supported.</p>
<p>Finally, we can now call the <code>UMAT</code> implementation as follows:</p>
<div class="sourceCode" id="cb20"><pre class="sourceCode cxx"><code class="sourceCode cpp"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>  <span class="va">umat_</span>(</span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>      s,        <span class="co">/* stress                   */</span></span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>      &amp;isvs[<span class="dv">0</span>], <span class="co">/* &amp;isvs[0], internal state variables */</span></span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a>      &amp;K(<span class="dv">0</span>, <span class="dv">0</span>), <span class="co">/* tangent operator         */</span></span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a>      &amp;sse, &amp;spd, &amp;scd, &amp;rpl, ddsddt, drplde, &amp;drpldt,</span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a>      e,                         <span class="co">/* strain tensor    */</span></span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a>      de,                        <span class="co">/* strain increment */</span></span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a>      time,                      <span class="co">//</span></span>
<span id="cb20-9"><a href="#cb20-9" aria-hidden="true" tabindex="-1"></a>      &amp;dt,                       <span class="co">/* time increment   */</span></span>
<span id="cb20-10"><a href="#cb20-10" aria-hidden="true" tabindex="-1"></a>      &amp;T,                        <span class="co">/* temperature      */</span></span>
<span id="cb20-11"><a href="#cb20-11" aria-hidden="true" tabindex="-1"></a>      &amp;dT,                       <span class="co">/* temperature increment    */</span></span>
<span id="cb20-12"><a href="#cb20-12" aria-hidden="true" tabindex="-1"></a>      pred,                      <span class="co">/* &amp;esvs[0], external state variables */</span></span>
<span id="cb20-13"><a href="#cb20-13" aria-hidden="true" tabindex="-1"></a>      dpred,                     <span class="co">/* &amp;desvs[0], external state variables */</span></span>
<span id="cb20-14"><a href="#cb20-14" aria-hidden="true" tabindex="-1"></a>      name, &amp;ndi, &amp;nshr, &amp;ntens, <span class="co">/* number of components of tensors */</span></span>
<span id="cb20-15"><a href="#cb20-15" aria-hidden="true" tabindex="-1"></a>      &amp;nstatv,                   <span class="co">/* number of internal state variables */</span></span>
<span id="cb20-16"><a href="#cb20-16" aria-hidden="true" tabindex="-1"></a>      &amp;mps[<span class="dv">0</span>],                   <span class="co">/* material properties                   */</span></span>
<span id="cb20-17"><a href="#cb20-17" aria-hidden="true" tabindex="-1"></a>      &amp;nprops,                   <span class="co">/* number of material properties */</span></span>
<span id="cb20-18"><a href="#cb20-18" aria-hidden="true" tabindex="-1"></a>      coords, drot,              <span class="co">/* rotation matrix                       */</span></span>
<span id="cb20-19"><a href="#cb20-19" aria-hidden="true" tabindex="-1"></a>      &amp;rdt,                      <span class="co">/* estimation of the next time increment */</span></span>
<span id="cb20-20"><a href="#cb20-20" aria-hidden="true" tabindex="-1"></a>      &amp;celent, dfgrd0, dfgrd1, &amp;noel, &amp;npt, &amp;layer, &amp;kspt, KSTEP,</span>
<span id="cb20-21"><a href="#cb20-21" aria-hidden="true" tabindex="-1"></a>      &amp;KINC, <span class="dv">80</span>);</span></code></pre></div>
<p>After the call, one checks that the behaviour integration succeeded by testing the value of the <code>KINC</code> variable:</p>
<div class="sourceCode" id="cb21"><pre class="sourceCode cxx"><code class="sourceCode cpp"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(KINC != <span class="dv">1</span>){</span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> FAILURE;</span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>  }</span></code></pre></div>
<p>If can of success, one converts the stress back to the <code>MFront</code> tensor:</p>
<div class="sourceCode" id="cb22"><pre class="sourceCode cxx"><code class="sourceCode cpp"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>  mfront_umat_wrapper::convertStressFromAbaqus&lt;hypothesis&gt;(&amp;sig[<span class="dv">0</span>], s);</span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<h2 data-number="4.9" id="sec:umat_wrapper:tangent_operator"><span class="header-section-number">4.9</span> Conversion of the tangent operator</h2>
<p>The <code>@TangentOperator</code> is only called, after the behaviour integration, if the consistent tangent operator has been requested by the solver. We can use this code block for the conversion of the consistent tangent operator as follows:</p>
<div class="sourceCode" id="cb23"><pre class="sourceCode cxx"><code class="sourceCode cpp"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="er">@</span>TangentOperator {</span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">static_cast</span>&lt;<span class="dt">void</span>&gt;(smt);</span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>  mfront_umat_wrapper::convertStiffnessMatrixFromAbaqus&lt;hypothesis&gt;(&amp;Dt(<span class="dv">0</span>, <span class="dv">0</span>),</span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a>                                                                    &amp;K(<span class="dv">0</span>, <span class="dv">0</span>));</span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>This optional conversion of the consistent tangent operator in a separate code block is the main reason why we stored the values of the consistent tangent operator in the local variable <code>K</code>.</p>
<h1 data-number="5" id="compiling-the-wrapper-outside-the-mfrontgallery"><span class="header-section-number">5</span> Compiling the wrapper outside the <code>MFrontGallery</code></h1>
<p>Firt this first test, we will compile the <code>umat</code> file in a seperate shared library that will be linked to the shared library generated by <code>MFront</code>. This is convenient as it does not require the user to handle the complexity of generating shared libraries built with different languages (<code>C++</code> and <code>fortran</code>) and barely relies on the standard compilation process provided by <code>MFront</code>.</p>
<h2 data-number="5.1" id="compiling-the-umat.f-file"><span class="header-section-number">5.1</span> Compiling the <code>umat.f</code> file</h2>
<p>In this tutorial, we compile the <code>umat.f</code> file as a shared library as follows:</p>
<div class="sourceCode" id="cb24"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> gfortran <span class="at">-O2</span> <span class="at">--shared</span> <span class="at">-fPIC</span> <span class="at">-DPIC</span> umat.f <span class="at">-o</span> libUmat.so</span></code></pre></div>
<h2 data-number="5.2" id="compiling-the-mfront-wrapper"><span class="header-section-number">5.2</span> Compiling the <code>MFront</code> wrapper</h2>
<p>The compilation of the <code>MFront</code> wrapper is almost standard:</p>
<div class="sourceCode" id="cb25"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> mfront <span class="at">-I</span> <span class="va">$(</span><span class="bu">pwd</span><span class="va">)</span> <span class="at">--obuild</span> <span class="at">--interface</span><span class="op">=</span>generic SmallStrainUmatWrapper.mfront <span class="dt">\</span></span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">--@Link</span><span class="op">=</span><span class="st">&#39;{&quot;-L ../ -lUmat&quot;}&#39;</span></span></code></pre></div>
<p>Two things must be noted about this command:</p>
<ul>
<li>We use the <code>-I</code> flag to add the current directory to the compiler’ header paths. This allows the compiler to find the <code>MFrontUmatWrapper.hxx</code> header.</li>
<li>We added additional link directives using the <code>@Link</code> keyword to link the generated shared library with the <code>libUmat.so</code> library. As the generated shared library is built in the <code>src</code> subdirectory, we must add the parent directory to the linker’ paths using the flag <code>-L ../</code>. We could have added this keyword in the <code>MFront</code> file but, as a matter of taste, we don’t like having relative paths inside an <code>MFront</code> file.</li>
</ul>
<h2 data-number="5.3" id="running-a-simple-test-with-mtest"><span class="header-section-number">5.3</span> Running a simple test with <code>MTest</code></h2>
<p>At this stage, we are able to test our wrapper in <code>MTest</code> using this simple uniaxial test:</p>
<div class="sourceCode" id="cb26"><pre class="sourceCode cxx"><code class="sourceCode cpp"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="er">@</span>ModellingHypothesis <span class="st">&quot;Tridimensional&quot;</span>;</span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a><span class="er">@</span>Behaviour&lt;generic&gt; <span class="st">&quot;src/libBehaviour.so&quot;</span> <span class="st">&quot;SmallStrainUmatWrapper&quot;</span>;</span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a><span class="co">// material properties</span></span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a><span class="er">@</span>MaterialProperty&lt;constant&gt; <span class="st">&quot;YoungModulus&quot;</span> <span class="fl">150e9</span>;</span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a><span class="er">@</span>MaterialProperty&lt;constant&gt; <span class="st">&quot;PoissonRatio&quot;</span> <span class="fl">0.3</span>;</span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-8"><a href="#cb26-8" aria-hidden="true" tabindex="-1"></a><span class="co">// external state variable</span></span>
<span id="cb26-9"><a href="#cb26-9" aria-hidden="true" tabindex="-1"></a><span class="er">@</span>ExternalStateVariable <span class="st">&quot;Temperature&quot;</span> <span class="fl">293.15</span>;</span>
<span id="cb26-10"><a href="#cb26-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-11"><a href="#cb26-11" aria-hidden="true" tabindex="-1"></a><span class="er">@</span>ImposedStrain <span class="st">&quot;EXX&quot;</span> {<span class="dv">0</span> : <span class="dv">0</span>, <span class="dv">1</span>: -<span class="fl">1.e-2</span>};</span>
<span id="cb26-12"><a href="#cb26-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-13"><a href="#cb26-13" aria-hidden="true" tabindex="-1"></a><span class="er">@</span>Times{<span class="dv">0</span>, <span class="dv">1</span> in <span class="dv">10</span>};</span></code></pre></div>
<p>This script can be executed as follows:</p>
<div class="sourceCode" id="cb27"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> mtest SmallStrainUmatWrapper.mtest</span></code></pre></div>
<blockquote>
<p><strong>Updating <code>LD_LIBRARY_PATH</code> </strong></p>
<p>Note that on some systems, one shall add the current directory to the <code>LD_LIBRARY_PATH</code> environment variable before calling <code>mtest</code> to find the <code>libUmat.so</code> library, as follows:</p>
<div class="sourceCode" id="cb28"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> export LD_LIBRARY_PATH=<span class="va">$(</span><span class="bu">pwd</span><span class="va">)</span>:<span class="va">$LD_LIBRARY_PATH</span></span></code></pre></div>
</blockquote>
<h1 data-number="6" id="sec:umat_wrapper:fortran95"><span class="header-section-number">6</span> A better solution</h1>
<p>The previous implementation can be improved in several ways. In this section, we propose a new implementations which:</p>
<ul>
<li>Reduces the number of parameters to the minimum, as the <code>UMAT</code> implementation effectively uses only a very limited subset of the arguments required by the <code>UMAT</code> interface.</li>
<li>Solves the portability issue using the <code>BIND(C)</code> attribute.</li>
</ul>
<h2 data-number="6.1" id="modification-of-the-fortran-sources"><span class="header-section-number">6.1</span> Modification of the <code>fortran</code> sources</h2>
<p>The first thing to do is to rename the file <code>umat.f</code> in <code>umat.f90</code> which is a more or less standard file extension for free-form fortran source greater than <code>Fortran 90</code> (extension like <code>f95</code> and <code>f03</code> does not seem to be supported by build systems and text editors, as explained <a href="https://fortranwiki.org/fortran/show/File+extensions">here</a>).</p>
<p>After converting the code to free form and removing the unused variables, the <code>umat2</code> subroutine has the following declaration:</p>
<div class="sourceCode" id="cb29"><pre class="sourceCode fortran"><code class="sourceCode fortranfixed"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="kw">subroutine</span> umat2(stress, ddsdde, stran, dstran, ntens, props, nprops) <span class="kw">&amp;</span></span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a>  BIND(C,NAME<span class="kw">=</span><span class="st">&quot;umat2&quot;</span>)</span></code></pre></div>
<p>See Listing 3 in Appendix 8.2 for the full code of the <code>umat2</code> subroutine.</p>
<p>The <code>NAME</code> option specifies the name of the exported symbol. This is the name of the function on the <code>C++</code> side. This name is now perfectly portable across implementations.</p>
<h2 data-number="6.2" id="modification-of-the-mfront-wrapper"><span class="header-section-number">6.2</span> Modification of the <code>MFront</code> wrapper</h2>
<p>Two code blocks of the <code>MFront</code> wrapper must be changed:</p>
<ul>
<li>The <code>@Includes</code> code block to change the declaration of the <code>umat</code> function.</li>
<li>The <code>@Integrator</code> code block to change the call of the <code>umat</code> function.</li>
</ul>
<h3 data-number="6.2.1" id="modifying-the-includes-code-block"><span class="header-section-number">6.2.1</span> Modifying the <code>@Includes</code> code block</h3>
<p>The <code>@Includes</code> code block is now much shorter, as follows:</p>
<div class="sourceCode" id="cb30"><pre class="sourceCode cxx"><code class="sourceCode cpp"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="er">@</span>Includes {</span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&quot;MFrontUmatWrapper.hxx&quot;</span></span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a><span class="pp">#ifndef MFRONT_UMAT2_FUNCTION_DECLARATION</span></span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a><span class="pp">#define MFRONT_UMAT2_FUNCTION_DECLARATION </span><span class="dv">1</span></span>
<span id="cb30-6"><a href="#cb30-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-7"><a href="#cb30-7" aria-hidden="true" tabindex="-1"></a><span class="at">extern</span> <span class="st">&quot;C&quot;</span> {</span>
<span id="cb30-8"><a href="#cb30-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-9"><a href="#cb30-9" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> umat2(</span>
<span id="cb30-10"><a href="#cb30-10" aria-hidden="true" tabindex="-1"></a>    AbaqusRealType *<span class="at">const</span>,          <span class="co">/* STRESS,  stress                   */</span></span>
<span id="cb30-11"><a href="#cb30-11" aria-hidden="true" tabindex="-1"></a>    AbaqusRealType *<span class="at">const</span>,          <span class="co">/* DDSDDE,  tangent operator         */</span></span>
<span id="cb30-12"><a href="#cb30-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">const</span> AbaqusRealType *<span class="at">const</span>,    <span class="co">/* STRAN, strain tensor    */</span></span>
<span id="cb30-13"><a href="#cb30-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">const</span> AbaqusRealType *<span class="at">const</span>,    <span class="co">/* DSTRAN,  strain increment */</span></span>
<span id="cb30-14"><a href="#cb30-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">const</span> AbaqusIntegerType *<span class="at">const</span>, <span class="co">/* NTENS, number of components of tensors */</span></span>
<span id="cb30-15"><a href="#cb30-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">const</span> AbaqusRealType *<span class="at">const</span>,    <span class="co">/* PROPS, material properties */</span></span>
<span id="cb30-16"><a href="#cb30-16" aria-hidden="true" tabindex="-1"></a>    <span class="at">const</span> AbaqusIntegerType *<span class="at">const</span>  <span class="co">/* NPROPS, number of material properties*/</span></span>
<span id="cb30-17"><a href="#cb30-17" aria-hidden="true" tabindex="-1"></a>);</span>
<span id="cb30-18"><a href="#cb30-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-19"><a href="#cb30-19" aria-hidden="true" tabindex="-1"></a>} <span class="co">// end of extern &quot;C&quot;</span></span>
<span id="cb30-20"><a href="#cb30-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-21"><a href="#cb30-21" aria-hidden="true" tabindex="-1"></a><span class="pp">#endif </span><span class="er">MFRONT_UMAT2_FUNCTION_DECLARATION 1</span></span>
<span id="cb30-22"><a href="#cb30-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-23"><a href="#cb30-23" aria-hidden="true" tabindex="-1"></a>} <span class="co">// end of @Includes</span></span></code></pre></div>
<h3 data-number="6.2.2" id="modifying-the-integrator-code-block"><span class="header-section-number">6.2.2</span> Modifying the <code>@Integrator</code> code block</h3>
<p>Once useless variables are removed, the source code of the <code>@Integrator</code> code block is also much shorter:</p>
<div class="sourceCode" id="cb31"><pre class="sourceCode cxx"><code class="sourceCode cpp"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="er">@</span>Integrator {</span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a>  <span class="co">//</span></span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">const</span> AbaqusRealType props[<span class="dv">2</span>] = {E, nu};</span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a>  <span class="co">//</span></span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a>  AbaqusRealType e[<span class="dv">6</span>];</span>
<span id="cb31-6"><a href="#cb31-6" aria-hidden="true" tabindex="-1"></a>  AbaqusRealType de[<span class="dv">6</span>];</span>
<span id="cb31-7"><a href="#cb31-7" aria-hidden="true" tabindex="-1"></a>  AbaqusRealType s[<span class="dv">6</span>];</span>
<span id="cb31-8"><a href="#cb31-8" aria-hidden="true" tabindex="-1"></a>  <span class="co">//</span></span>
<span id="cb31-9"><a href="#cb31-9" aria-hidden="true" tabindex="-1"></a>  mfront_umat_wrapper::convertStrainToAbaqus&lt;hypothesis&gt;(e, &amp;eto[<span class="dv">0</span>]);</span>
<span id="cb31-10"><a href="#cb31-10" aria-hidden="true" tabindex="-1"></a>  mfront_umat_wrapper::convertStrainToAbaqus&lt;hypothesis&gt;(de, &amp;deto[<span class="dv">0</span>]);</span>
<span id="cb31-11"><a href="#cb31-11" aria-hidden="true" tabindex="-1"></a>  mfront_umat_wrapper::convertStressToAbaqus&lt;hypothesis&gt;(s, &amp;sig[<span class="dv">0</span>]);</span>
<span id="cb31-12"><a href="#cb31-12" aria-hidden="true" tabindex="-1"></a>  <span class="co">//</span></span>
<span id="cb31-13"><a href="#cb31-13" aria-hidden="true" tabindex="-1"></a>  <span class="at">const</span> <span class="kw">auto</span> nprops = <span class="kw">static_cast</span>&lt;AbaqusIntegerType&gt;(<span class="dv">2</span>);</span>
<span id="cb31-14"><a href="#cb31-14" aria-hidden="true" tabindex="-1"></a>  <span class="at">const</span> <span class="kw">auto</span> ntens = <span class="kw">static_cast</span>&lt;AbaqusIntegerType&gt;(<span class="dv">6</span>);</span>
<span id="cb31-15"><a href="#cb31-15" aria-hidden="true" tabindex="-1"></a>  <span class="co">//</span></span>
<span id="cb31-16"><a href="#cb31-16" aria-hidden="true" tabindex="-1"></a>  umat2(s,         <span class="co">/* stress              */</span></span>
<span id="cb31-17"><a href="#cb31-17" aria-hidden="true" tabindex="-1"></a>        &amp;K(<span class="dv">0</span>, <span class="dv">0</span>),  <span class="co">/* tangent operator    */</span></span>
<span id="cb31-18"><a href="#cb31-18" aria-hidden="true" tabindex="-1"></a>        e,         <span class="co">/* strain tensor       */</span></span>
<span id="cb31-19"><a href="#cb31-19" aria-hidden="true" tabindex="-1"></a>        de,        <span class="co">/* strain increment    */</span></span>
<span id="cb31-20"><a href="#cb31-20" aria-hidden="true" tabindex="-1"></a>        &amp;ntens,    <span class="co">/* number of components of the stress tensor*/</span></span>
<span id="cb31-21"><a href="#cb31-21" aria-hidden="true" tabindex="-1"></a>        &amp;props[<span class="dv">0</span>], <span class="co">/* material properties */</span></span>
<span id="cb31-22"><a href="#cb31-22" aria-hidden="true" tabindex="-1"></a>        &amp;nprops    <span class="co">/* number of material properties*/</span></span>
<span id="cb31-23"><a href="#cb31-23" aria-hidden="true" tabindex="-1"></a>  );</span>
<span id="cb31-24"><a href="#cb31-24" aria-hidden="true" tabindex="-1"></a>  <span class="co">//</span></span>
<span id="cb31-25"><a href="#cb31-25" aria-hidden="true" tabindex="-1"></a>  mfront_umat_wrapper::convertStressFromAbaqus&lt;hypothesis&gt;(&amp;sig[<span class="dv">0</span>], s);</span>
<span id="cb31-26"><a href="#cb31-26" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>As a rule of thumb, reducing the number of arguments passed from <code>C++</code> to <code>fortran</code> to the bare minimum is highly recommended as there is no way for the compiler of the linker to check the consistency of those arguments. It is the responsability of the developper to make the <code>C++</code> call match the <code>fortran</code> declaration. This is the source of hours of painful debugging.</p>
<h1 data-number="7" id="introducing-the-wrapped-implementation-in-mfrontgallery"><span class="header-section-number">7</span> Introducing the wrapped implementation in <code>MFrontGallery</code></h1>
<h2 data-number="7.1" id="the-mfrontuserwrapper.hxx-header"><span class="header-section-number">7.1</span> The <code>MFrontUserWrapper.hxx</code> header</h2>
<p>The <code>MFrontUserWrapper.hxx</code> header may be shared between several wrappers. Such headers may be rightfully be placed in the <code>include</code> directory at the root of the <code>MFrontGallery</code> project.</p>
<p>If it exists, this directory is automatically added to the compiler’ include path by the <a href="cmake-infrastructure.html"><code>cmake</code> infrastructure</a>.</p>
<p>However, as the project grows, such shared utility headers may multiply, with the risk of a cluttering of the <code>include</code> directory.</p>
<p>To sort things out, we choose to create an <code>MFront/Wrappers</code> subdirectory. We also choose to rename the file <code>UmatWrapper.hxx</code> to avoid a redundant <code>MFront</code>.</p>
<h2 data-number="7.2" id="building-the-libraries"><span class="header-section-number">7.2</span> Building the libraries</h2>
<p>We choose to create two libraries <code>v1</code> and <code>v1</code> for each versions of the wrapped behaviour. Those directories are placed in the <code>unit-tests/mfront-wrappers/fortran/umat/</code> directory.</p>
<blockquote>
<p><strong>The <code>enable-fortran-behaviours-wrappers</code> options</strong></p>
<p>The subdirectories of the <code>mfront-wrappers/fortran</code> directory are only treated if the <code>enable-fortran-behaviours-wrappers</code> has been set to <code>ON</code> at the <code>cmake</code> configuration stage (see the <a href="install.html">install page</a> for details).</p>
<p>This options ensures that proper support of <code>Fortran</code> language has been set up.</p>
</blockquote>
<p>The content of those directories is the following:</p>
<div class="sourceCode" id="cb32"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="ex">mfront-wrappers/fortran/umat</span></span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a><span class="ex">├──</span> mfront-wrappers/fortran/umat/v1</span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a><span class="ex">│</span>   ├── mfront-wrappers/fortran/umat/v1/CMakeLists.txt</span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a><span class="ex">│</span>   ├── mfront-wrappers/fortran/umat/v1/SmallStrainUmatWrapper_v1.mfront</span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true" tabindex="-1"></a><span class="ex">│</span>   └── mfront-wrappers/fortran/umat/v1/umat.f</span>
<span id="cb32-6"><a href="#cb32-6" aria-hidden="true" tabindex="-1"></a><span class="ex">└──</span> mfront-wrappers/fortran/umat/v2</span>
<span id="cb32-7"><a href="#cb32-7" aria-hidden="true" tabindex="-1"></a>    <span class="ex">├──</span> mfront-wrappers/fortran/umat/v2/CMakeLists.txt</span>
<span id="cb32-8"><a href="#cb32-8" aria-hidden="true" tabindex="-1"></a>    <span class="ex">├──</span> mfront-wrappers/fortran/umat/v2/SmallStrainUmatWrapper_v2.mfront</span>
<span id="cb32-9"><a href="#cb32-9" aria-hidden="true" tabindex="-1"></a>    <span class="ex">└──</span> mfront-wrappers/fortran/umat/v2/umat2.f90</span></code></pre></div>
<p>For the sake of clarity, the <code>MFront</code> implementations have been renamed and the name of the generated behaviours changes accordingly.</p>
<h3 data-number="7.2.1" id="second-version-of-the-wrapper"><span class="header-section-number">7.2.1</span> Second version of the wrapper</h3>
<p>The contents of the <code>CMakeLists.txt</code> are very simple for the second version, as shown by the following listing:</p>
<div class="sourceCode" id="cb33"><pre class="sourceCode cmake"><code class="sourceCode cmake"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="fu">mfront_behaviours_library</span>(UmatWrapperV2</span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a>  SmallStrainUmatWrapperV2</span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a>  umat2.f90)</span></code></pre></div>
<p>The <code>mfront_behaviour_library</code> function is described in the documentation of the <a href="cmake-infrastructure.html">cmake infrastructure</a> of the project.</p>
<p>This call to the <code>mfront_behaviour_library</code> function generates the following output:</p>
<div class="sourceCode" id="cb34"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="ex">--</span> Adding library : UMATWRAPPERV2CALCULIXBEHAVIOURS</span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">(</span><span class="ex">mfront-wrappers/fortran/umat/v2/calculix/src/calculixSmallStrainUmatWrapper_v2.cxx</span><span class="kw">;</span></span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a>   <span class="ex">mfront-wrappers/fortran/umat/v2/calculix/src/SmallStrainUmatWrapper_v2.cxx</span><span class="kw">;</span><span class="ex">umat2.f90</span><span class="er">)</span></span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true" tabindex="-1"></a><span class="ex">--</span> Adding library : UMATWRAPPERV2ANSYSBEHAVIOURS</span>
<span id="cb34-5"><a href="#cb34-5" aria-hidden="true" tabindex="-1"></a>  <span class="kw">(</span><span class="ex">mfront-wrappers/fortran/umat/v2/ansys/src/ansysSmallStrainUmatWrapper_v2.cxx</span><span class="kw">;</span></span>
<span id="cb34-6"><a href="#cb34-6" aria-hidden="true" tabindex="-1"></a>   <span class="ex">mfront-wrappers/fortran/umat/v2/ansys/src/SmallStrainUmatWrapper_v2.cxx</span><span class="kw">;</span><span class="ex">umat2.f90</span><span class="er">)</span></span>
<span id="cb34-7"><a href="#cb34-7" aria-hidden="true" tabindex="-1"></a><span class="ex">--</span> Adding library : UMATWRAPPERV2ABAQUSBEHAVIOURS</span>
<span id="cb34-8"><a href="#cb34-8" aria-hidden="true" tabindex="-1"></a>  <span class="kw">(</span><span class="ex">mfront-wrappers/fortran/umat/v2/abaqus/src/abaqusSmallStrainUmatWrapper_v2.cxx</span><span class="kw">;</span></span>
<span id="cb34-9"><a href="#cb34-9" aria-hidden="true" tabindex="-1"></a>   <span class="ex">mfront-wrappers/fortran/umat/v2/abaqus/src/SmallStrainUmatWrapper_v2.cxx</span><span class="kw">;</span><span class="ex">umat2.f90</span><span class="er">)</span></span>
<span id="cb34-10"><a href="#cb34-10" aria-hidden="true" tabindex="-1"></a><span class="ex">--</span> SmallStrainUmatWrapper_v2 has been discarded for interface cyrano</span>
<span id="cb34-11"><a href="#cb34-11" aria-hidden="true" tabindex="-1"></a>  <span class="kw">(</span><span class="ex">behaviour</span> does not support any of the  <span class="st">&#39;AxisymmetricalGeneralisedPlaneStrain&#39;</span></span>
<span id="cb34-12"><a href="#cb34-12" aria-hidden="true" tabindex="-1"></a>   <span class="ex">or</span>  <span class="st">&#39;AxisymmetricalGeneralisedPlaneStress modelling&#39;</span> hypothesis<span class="kw">)</span></span>
<span id="cb34-13"><a href="#cb34-13" aria-hidden="true" tabindex="-1"></a><span class="ex">--</span> Only external sources provided for library UmatWrapperV2Behaviours-cyrano for</span>
<span id="cb34-14"><a href="#cb34-14" aria-hidden="true" tabindex="-1"></a>   <span class="ex">interface</span> cyrano. The generation of this library is disabled by default.</span>
<span id="cb34-15"><a href="#cb34-15" aria-hidden="true" tabindex="-1"></a>   <span class="ex">It</span> can be enabled by using the GENERATE_WITHOUT_MFRONT_SOURCES option</span>
<span id="cb34-16"><a href="#cb34-16" aria-hidden="true" tabindex="-1"></a><span class="ex">--</span> SmallStrainUmatWrapper_v2 has been discarded for interface epx</span>
<span id="cb34-17"><a href="#cb34-17" aria-hidden="true" tabindex="-1"></a>  <span class="kw">(</span><span class="ex">small</span> strain behaviours are not supported<span class="kw">)</span></span>
<span id="cb34-18"><a href="#cb34-18" aria-hidden="true" tabindex="-1"></a><span class="ex">--</span> Only external sources provided for library UmatWrapperV2Behaviours-epx for</span>
<span id="cb34-19"><a href="#cb34-19" aria-hidden="true" tabindex="-1"></a>   <span class="ex">interface</span> epx. The generation of this library is disabled by default.</span>
<span id="cb34-20"><a href="#cb34-20" aria-hidden="true" tabindex="-1"></a>   <span class="ex">It</span> can be enabled by using the GENERATE_WITHOUT_MFRONT_SOURCES option</span>
<span id="cb34-21"><a href="#cb34-21" aria-hidden="true" tabindex="-1"></a><span class="ex">--</span> Adding library : UmatWrapperV2DianaFEABehaviours</span>
<span id="cb34-22"><a href="#cb34-22" aria-hidden="true" tabindex="-1"></a>  <span class="kw">(</span><span class="ex">mfront-wrappers/fortran/umat/v2/dianafea/src/DianaFEASmallStrainUmatWrapper_v2.cxx</span><span class="kw">;</span></span>
<span id="cb34-23"><a href="#cb34-23" aria-hidden="true" tabindex="-1"></a>   <span class="ex">mfront-wrappers/fortran/umat/v2/dianafea/src/SmallStrainUmatWrapper_v2.cxx</span><span class="kw">;</span><span class="ex">umat2.f90</span><span class="er">)</span></span>
<span id="cb34-24"><a href="#cb34-24" aria-hidden="true" tabindex="-1"></a><span class="ex">--</span> Adding library : UmatWrapperV2Behaviours-aster</span>
<span id="cb34-25"><a href="#cb34-25" aria-hidden="true" tabindex="-1"></a>  <span class="kw">(</span><span class="ex">mfront-wrappers/fortran/umat/v2/aster/src/asterSmallStrainUmatWrapper_v2.cxx</span><span class="kw">;</span></span>
<span id="cb34-26"><a href="#cb34-26" aria-hidden="true" tabindex="-1"></a>   <span class="ex">mfront-wrappers/fortran/umat/v2/aster/src/SmallStrainUmatWrapper_v2.cxx</span><span class="kw">;</span><span class="ex">umat2.f90</span><span class="er">)</span></span>
<span id="cb34-27"><a href="#cb34-27" aria-hidden="true" tabindex="-1"></a><span class="ex">--</span> Adding library : UmatWrapperV2Behaviours</span>
<span id="cb34-28"><a href="#cb34-28" aria-hidden="true" tabindex="-1"></a>  <span class="kw">(</span><span class="ex">mfront-wrappers/fortran/umat/v2/castem/src/umatSmallStrainUmatWrapper_v2.cxx</span><span class="kw">;</span></span>
<span id="cb34-29"><a href="#cb34-29" aria-hidden="true" tabindex="-1"></a>   <span class="ex">mfront-wrappers/fortran/umat/v2/castem/src/SmallStrainUmatWrapper_v2.cxx</span><span class="kw">;</span><span class="ex">umat2.f90</span><span class="er">)</span></span>
<span id="cb34-30"><a href="#cb34-30" aria-hidden="true" tabindex="-1"></a><span class="ex">--</span> Adding library : UmatWrapperV2Behaviours-generic</span>
<span id="cb34-31"><a href="#cb34-31" aria-hidden="true" tabindex="-1"></a>  <span class="kw">(</span><span class="ex">mfront-wrappers/fortran/umat/v2/generic/src/SmallStrainUmatWrapper_v2-generic.cxx</span><span class="kw">;</span></span>
<span id="cb34-32"><a href="#cb34-32" aria-hidden="true" tabindex="-1"></a>   <span class="ex">mfront-wrappers/fortran/umat/v2/generic/src/SmallStrainUmatWrapper_v2.cxx</span><span class="kw">;</span><span class="ex">umat2.f90</span><span class="er">)</span></span></code></pre></div>
<p>This output shows that:</p>
<ul>
<li>The wrapped behaviour is not compatible with some interfaces (<code>cyrano</code>, <code>europlexus</code> for instance) for reasons explicitely stated in the previous output.</li>
<li>No library is generated by default if no <code>MFront</code> sources are compatible with the given interface. This could be changed by passing the <code>GENERATE_WITHOUT_MFRONT_SOURCES</code> option to the <code>mfront_behaviour_library</code> function.</li>
</ul>
<blockquote>
<p><strong>Compiling the <code>fortran</code> sources in a separate shared library</strong></p>
<p>Contrary to the standalone example, the <code>fortran</code> sources are compiled in the same shared library than the <code>MFront</code> file. Note that the <code>fortran</code> sources are compiled once for each interfaces.</p>
<p>Another strategy would be to compile the <code>fortran</code> file in a separate shared library and link the <code>MFront</code> shared libraries to this shared library. This can be done as follows:</p>
<div class="sourceCode" id="cb35"><pre class="sourceCode cmake"><code class="sourceCode cmake"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="kw">add_library</span>(UmatImplementations <span class="ot">SHARED</span> umat2.f90)</span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a><span class="fu">mfm_install_library</span>(UmatImplementations)</span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a><span class="fu">mfront_behaviours_library</span>(UmatWrapperV2</span>
<span id="cb35-5"><a href="#cb35-5" aria-hidden="true" tabindex="-1"></a> SmallStrainUmatWrapper_v2</span>
<span id="cb35-6"><a href="#cb35-6" aria-hidden="true" tabindex="-1"></a> <span class="dv">LINK_LIBRARIES</span> UmatImplementations)</span></code></pre></div>
</blockquote>
<h3 data-number="7.2.2" id="first-version-of-the-wrapper"><span class="header-section-number">7.2.2</span> First version of the wrapper</h3>
<p>The <code>CMakeLists.txt</code> file for the first version of the wrapper is a bit more involved as we try to avoid the portability issue by compiling the <code>UmatWrapper_v2</code> only if:</p>
<ul>
<li>the <code>fortran</code> compiler is <code>gfortran</code>.</li>
<li>the targeted system is <code>Linux</code>.</li>
</ul>
<p>This is illustrated by the following script:</p>
<div class="sourceCode" id="cb36"><pre class="sourceCode cxx"><code class="sourceCode cpp"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(GNU_FORTRAN_COMPILER AND (<span class="er">$</span>{CMAKE_SYSTEM_NAME} STREQUAL <span class="st">&quot;Linux&quot;</span>))</span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a>  mfront_behaviours_library(UmatWrapperV1</span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a>    SmallStrainUmatWrapper_v1</span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a>    umat.f)</span>
<span id="cb36-5"><a href="#cb36-5" aria-hidden="true" tabindex="-1"></a>endif()</span></code></pre></div>
<p>The <code>GNU_FORTRAN_COMPILER</code> variable is automatically defined by the <code>cmake</code> infrastructure of the project.</p>
<!--
# Acknowledgements

The development of TFEL/MFront is conducted in the framework of the
`PLEIADES` project, which is supported financially by the French
Alternative Energies and Atomic Energy Commission (CEA), Électricité de
France (EDF) and Framatome.

We also acknowledge contributions from Thomas Nagel and David Mašín
during the genesis of this project. The funding by BGE mbH, the German
federal company for radioactive waste is greatly acknowledged.

\appendix
-->
<h1 data-number="8" id="appendix"><span class="header-section-number">8</span> Appendix</h1>
<h2 data-number="8.1" id="sec:umat_wrapper:umat_source_code"><span class="header-section-number">8.1</span> Source code of the <code>UMAT</code> subroutine</h2>
<p>The source code of the <code>umat2</code> subroutine is reported in Listing 2.</p>
<div id="lst:umat_wrapper:umat_source_code" class="listing fortran">
<p>Listing 2: Source code of the `UMAT` subroutine</p>
<div class="sourceCode" id="cb37"><pre class="sourceCode fortran"><code class="sourceCode fortranfixed"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="bu">     s</span>ubroutine umat(stress,statev,ddsdde,sse,spd,scd,</span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a><span class="bu">     &amp;</span>  rpl,ddsddt,drplde,drpldt,</span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a><span class="bu">     &amp;</span>  stran,dstran,time,dtime,temp,dtemp,predef,dpred,cmname,</span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a><span class="bu">     &amp;</span>  ndi,nshr,ntens,nstatv,props,nprops,coords,drot,pnewdt,</span>
<span id="cb37-5"><a href="#cb37-5" aria-hidden="true" tabindex="-1"></a><span class="bu">     &amp;</span>  celent,dfgrd0,dfgrd1,noel,npt,layer,kspt,kstep,kinc)</span>
<span id="cb37-6"><a href="#cb37-6" aria-hidden="true" tabindex="-1"></a><span class="co">!</span></span>
<span id="cb37-7"><a href="#cb37-7" aria-hidden="true" tabindex="-1"></a>      <span class="kw">implicit</span> <span class="kw">none</span></span>
<span id="cb37-8"><a href="#cb37-8" aria-hidden="true" tabindex="-1"></a><span class="co">!</span></span>
<span id="cb37-9"><a href="#cb37-9" aria-hidden="true" tabindex="-1"></a>      <span class="dt">character*80</span> cmname</span>
<span id="cb37-10"><a href="#cb37-10" aria-hidden="true" tabindex="-1"></a><span class="co">!</span></span>
<span id="cb37-11"><a href="#cb37-11" aria-hidden="true" tabindex="-1"></a>      <span class="dt">integer</span> ndi,nshr,ntens,nstatv,nprops,noel,npt,layer,kspt,</span>
<span id="cb37-12"><a href="#cb37-12" aria-hidden="true" tabindex="-1"></a><span class="bu">     &amp;</span>  kstep,kinc</span>
<span id="cb37-13"><a href="#cb37-13" aria-hidden="true" tabindex="-1"></a><span class="co">!</span></span>
<span id="cb37-14"><a href="#cb37-14" aria-hidden="true" tabindex="-1"></a>      <span class="dt">real*8</span> stress(ntens),statev(nstatv),</span>
<span id="cb37-15"><a href="#cb37-15" aria-hidden="true" tabindex="-1"></a><span class="bu">     &amp;</span>  ddsdde(ntens,ntens),ddsddt(ntens),drplde(ntens),</span>
<span id="cb37-16"><a href="#cb37-16" aria-hidden="true" tabindex="-1"></a><span class="bu">     &amp;</span>  stran(ntens),dstran(ntens),time(<span class="dv">2</span>),celent,</span>
<span id="cb37-17"><a href="#cb37-17" aria-hidden="true" tabindex="-1"></a><span class="bu">     &amp;</span>  props(nprops),coords(<span class="dv">3</span>),drot(<span class="dv">3</span>,<span class="dv">3</span>),dfgrd0(<span class="dv">3</span>,<span class="dv">3</span>),dfgrd1(<span class="dv">3</span>,<span class="dv">3</span>),</span>
<span id="cb37-18"><a href="#cb37-18" aria-hidden="true" tabindex="-1"></a><span class="bu">     &amp;</span>  sse,spd,scd,rpl,drpldt,dtime,temp,dtemp,predef,dpred,</span>
<span id="cb37-19"><a href="#cb37-19" aria-hidden="true" tabindex="-1"></a><span class="bu">     &amp;</span>  pnewdt</span>
<span id="cb37-20"><a href="#cb37-20" aria-hidden="true" tabindex="-1"></a><span class="co">!</span></span>
<span id="cb37-21"><a href="#cb37-21" aria-hidden="true" tabindex="-1"></a>      <span class="dt">integer</span> i,j</span>
<span id="cb37-22"><a href="#cb37-22" aria-hidden="true" tabindex="-1"></a>      <span class="dt">real*8</span> e,un,al,um,am1,am2</span>
<span id="cb37-23"><a href="#cb37-23" aria-hidden="true" tabindex="-1"></a><span class="co">!</span></span>
<span id="cb37-24"><a href="#cb37-24" aria-hidden="true" tabindex="-1"></a>      e<span class="kw">=</span>props(<span class="dv">1</span>)</span>
<span id="cb37-25"><a href="#cb37-25" aria-hidden="true" tabindex="-1"></a>      un<span class="kw">=</span>props(<span class="dv">2</span>)</span>
<span id="cb37-26"><a href="#cb37-26" aria-hidden="true" tabindex="-1"></a>      al<span class="kw">=</span>un<span class="kw">*</span>e<span class="kw">/</span>(<span class="fl">1.d0</span><span class="kw">+</span>un)<span class="kw">/</span>(<span class="fl">1.d0</span><span class="kw">-</span><span class="fl">2.d0</span><span class="kw">*</span>un)</span>
<span id="cb37-27"><a href="#cb37-27" aria-hidden="true" tabindex="-1"></a>      um<span class="kw">=</span>e<span class="kw">/</span><span class="fl">2.d0</span><span class="kw">/</span>(<span class="fl">1.d0</span><span class="kw">+</span>un)</span>
<span id="cb37-28"><a href="#cb37-28" aria-hidden="true" tabindex="-1"></a>      am1<span class="kw">=</span>al<span class="kw">+</span><span class="fl">2.d0</span><span class="kw">*</span>um</span>
<span id="cb37-29"><a href="#cb37-29" aria-hidden="true" tabindex="-1"></a>      am2<span class="kw">=</span>um</span>
<span id="cb37-30"><a href="#cb37-30" aria-hidden="true" tabindex="-1"></a><span class="co">!</span></span>
<span id="cb37-31"><a href="#cb37-31" aria-hidden="true" tabindex="-1"></a><span class="co">!     stress</span></span>
<span id="cb37-32"><a href="#cb37-32" aria-hidden="true" tabindex="-1"></a><span class="co">!      </span></span>
<span id="cb37-33"><a href="#cb37-33" aria-hidden="true" tabindex="-1"></a>      stress(<span class="dv">1</span>)<span class="kw">=</span>stress(<span class="dv">1</span>)<span class="kw">+</span>am1<span class="kw">*</span>dstran(<span class="dv">1</span>)<span class="kw">+</span>al<span class="kw">*</span>(dstran(<span class="dv">2</span>)<span class="kw">+</span>dstran(<span class="dv">3</span>))</span>
<span id="cb37-34"><a href="#cb37-34" aria-hidden="true" tabindex="-1"></a>      stress(<span class="dv">2</span>)<span class="kw">=</span>stress(<span class="dv">2</span>)<span class="kw">+</span>am1<span class="kw">*</span>dstran(<span class="dv">2</span>)<span class="kw">+</span>al<span class="kw">*</span>(dstran(<span class="dv">1</span>)<span class="kw">+</span>dstran(<span class="dv">3</span>))</span>
<span id="cb37-35"><a href="#cb37-35" aria-hidden="true" tabindex="-1"></a>      stress(<span class="dv">3</span>)<span class="kw">=</span>stress(<span class="dv">3</span>)<span class="kw">+</span>am1<span class="kw">*</span>dstran(<span class="dv">3</span>)<span class="kw">+</span>al<span class="kw">*</span>(dstran(<span class="dv">1</span>)<span class="kw">+</span>dstran(<span class="dv">2</span>))</span>
<span id="cb37-36"><a href="#cb37-36" aria-hidden="true" tabindex="-1"></a>      stress(<span class="dv">4</span>)<span class="kw">=</span>stress(<span class="dv">4</span>)<span class="kw">+</span>am2<span class="kw">*</span>dstran(<span class="dv">4</span>)</span>
<span id="cb37-37"><a href="#cb37-37" aria-hidden="true" tabindex="-1"></a>      stress(<span class="dv">5</span>)<span class="kw">=</span>stress(<span class="dv">5</span>)<span class="kw">+</span>am2<span class="kw">*</span>dstran(<span class="dv">5</span>)</span>
<span id="cb37-38"><a href="#cb37-38" aria-hidden="true" tabindex="-1"></a>      stress(<span class="dv">6</span>)<span class="kw">=</span>stress(<span class="dv">6</span>)<span class="kw">+</span>am2<span class="kw">*</span>dstran(<span class="dv">6</span>)</span>
<span id="cb37-39"><a href="#cb37-39" aria-hidden="true" tabindex="-1"></a><span class="co">!</span></span>
<span id="cb37-40"><a href="#cb37-40" aria-hidden="true" tabindex="-1"></a><span class="co">!     stiffness</span></span>
<span id="cb37-41"><a href="#cb37-41" aria-hidden="true" tabindex="-1"></a><span class="co">!</span></span>
<span id="cb37-42"><a href="#cb37-42" aria-hidden="true" tabindex="-1"></a>      <span class="kw">do</span> i<span class="kw">=</span><span class="dv">1</span>,<span class="dv">6</span></span>
<span id="cb37-43"><a href="#cb37-43" aria-hidden="true" tabindex="-1"></a>         <span class="kw">do</span> j<span class="kw">=</span><span class="dv">1</span>,<span class="dv">6</span></span>
<span id="cb37-44"><a href="#cb37-44" aria-hidden="true" tabindex="-1"></a>            ddsdde(i,j)<span class="kw">=</span><span class="fl">0.d0</span></span>
<span id="cb37-45"><a href="#cb37-45" aria-hidden="true" tabindex="-1"></a>         <span class="kw">enddo</span></span>
<span id="cb37-46"><a href="#cb37-46" aria-hidden="true" tabindex="-1"></a>      <span class="kw">enddo</span></span>
<span id="cb37-47"><a href="#cb37-47" aria-hidden="true" tabindex="-1"></a>      ddsdde(<span class="dv">1</span>,<span class="dv">1</span>)<span class="kw">=</span>al<span class="kw">+</span><span class="fl">2.d0</span><span class="kw">*</span>um</span>
<span id="cb37-48"><a href="#cb37-48" aria-hidden="true" tabindex="-1"></a>      ddsdde(<span class="dv">1</span>,<span class="dv">2</span>)<span class="kw">=</span>al</span>
<span id="cb37-49"><a href="#cb37-49" aria-hidden="true" tabindex="-1"></a>      ddsdde(<span class="dv">2</span>,<span class="dv">1</span>)<span class="kw">=</span>al</span>
<span id="cb37-50"><a href="#cb37-50" aria-hidden="true" tabindex="-1"></a>      ddsdde(<span class="dv">2</span>,<span class="dv">2</span>)<span class="kw">=</span>al<span class="kw">+</span><span class="fl">2.d0</span><span class="kw">*</span>um</span>
<span id="cb37-51"><a href="#cb37-51" aria-hidden="true" tabindex="-1"></a>      ddsdde(<span class="dv">1</span>,<span class="dv">3</span>)<span class="kw">=</span>al</span>
<span id="cb37-52"><a href="#cb37-52" aria-hidden="true" tabindex="-1"></a>      ddsdde(<span class="dv">3</span>,<span class="dv">1</span>)<span class="kw">=</span>al</span>
<span id="cb37-53"><a href="#cb37-53" aria-hidden="true" tabindex="-1"></a>      ddsdde(<span class="dv">2</span>,<span class="dv">3</span>)<span class="kw">=</span>al</span>
<span id="cb37-54"><a href="#cb37-54" aria-hidden="true" tabindex="-1"></a>      ddsdde(<span class="dv">3</span>,<span class="dv">2</span>)<span class="kw">=</span>al</span>
<span id="cb37-55"><a href="#cb37-55" aria-hidden="true" tabindex="-1"></a>      ddsdde(<span class="dv">3</span>,<span class="dv">3</span>)<span class="kw">=</span>al<span class="kw">+</span><span class="fl">2.d0</span><span class="kw">*</span>um</span>
<span id="cb37-56"><a href="#cb37-56" aria-hidden="true" tabindex="-1"></a>      ddsdde(<span class="dv">4</span>,<span class="dv">4</span>)<span class="kw">=</span>um</span>
<span id="cb37-57"><a href="#cb37-57" aria-hidden="true" tabindex="-1"></a>      ddsdde(<span class="dv">5</span>,<span class="dv">5</span>)<span class="kw">=</span>um</span>
<span id="cb37-58"><a href="#cb37-58" aria-hidden="true" tabindex="-1"></a>      ddsdde(<span class="dv">6</span>,<span class="dv">6</span>)<span class="kw">=</span>um</span>
<span id="cb37-59"><a href="#cb37-59" aria-hidden="true" tabindex="-1"></a><span class="co">!</span></span>
<span id="cb37-60"><a href="#cb37-60" aria-hidden="true" tabindex="-1"></a><span class="co">!     </span><span class="re">END</span><span class="co"> EXAMPLE LINEAR ELASTIC MATERIAL</span></span>
<span id="cb37-61"><a href="#cb37-61" aria-hidden="true" tabindex="-1"></a><span class="co">!</span></span>
<span id="cb37-62"><a href="#cb37-62" aria-hidden="true" tabindex="-1"></a>      <span class="kw">return</span></span>
<span id="cb37-63"><a href="#cb37-63" aria-hidden="true" tabindex="-1"></a>      <span class="kw">end</span></span></code></pre></div>
</div>
<h2 data-number="8.2" id="sec:umat_wrapper:umat2_source_code"><span class="header-section-number">8.2</span> Source code of the <code>umat2</code> subroutine in <code>Fortran 2003</code></h2>
<p>The source code of the <code>umat2</code> subroutine is reported in Listing 3.</p>
<div id="lst:umat_wrapper:umat2_source_code" class="listing fortran">
<p>Listing 3: Source code of the `umat2` subroutine</p>
<div class="sourceCode" id="cb38"><pre class="sourceCode fortran"><code class="sourceCode fortranfixed"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a><span class="kw">subroutine</span> umat2(stress, ddsdde, stran, dstran, ntens, props, nprops) BIND(C,NAME<span class="kw">=</span><span class="st">&quot;umat2&quot;</span>)</span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a><span class="co">!</span></span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a><span class="kw">implicit</span> <span class="kw">none</span></span>
<span id="cb38-4"><a href="#cb38-4" aria-hidden="true" tabindex="-1"></a><span class="dt">integer</span> ntens,nprops</span>
<span id="cb38-5"><a href="#cb38-5" aria-hidden="true" tabindex="-1"></a><span class="dt">real*8</span> stress(ntens), ddsdde(ntens,ntens),stran(ntens), dstran(ntens), props(nprops)</span>
<span id="cb38-6"><a href="#cb38-6" aria-hidden="true" tabindex="-1"></a><span class="co">!</span></span>
<span id="cb38-7"><a href="#cb38-7" aria-hidden="true" tabindex="-1"></a><span class="dt">integer</span> i,j</span>
<span id="cb38-8"><a href="#cb38-8" aria-hidden="true" tabindex="-1"></a><span class="dt">real*8</span> e,un,al,um,am1,am2</span>
<span id="cb38-9"><a href="#cb38-9" aria-hidden="true" tabindex="-1"></a><span class="co">!</span></span>
<span id="cb38-10"><a href="#cb38-10" aria-hidden="true" tabindex="-1"></a>e<span class="kw">=</span>props(<span class="dv">1</span>)</span>
<span id="cb38-11"><a href="#cb38-11" aria-hidden="true" tabindex="-1"></a>un<span class="kw">=</span>props(<span class="dv">2</span>)</span>
<span id="cb38-12"><a href="#cb38-12" aria-hidden="true" tabindex="-1"></a>al<span class="kw">=</span>un<span class="kw">*</span>e<span class="kw">/</span>(<span class="fl">1.d0</span><span class="kw">+</span>un)<span class="kw">/</span>(<span class="fl">1.d0</span><span class="kw">-</span><span class="fl">2.d0</span><span class="kw">*</span>un)</span>
<span id="cb38-13"><a href="#cb38-13" aria-hidden="true" tabindex="-1"></a>um<span class="kw">=</span>e<span class="kw">/</span><span class="fl">2.d0</span><span class="kw">/</span>(<span class="fl">1.d0</span><span class="kw">+</span>un)</span>
<span id="cb38-14"><a href="#cb38-14" aria-hidden="true" tabindex="-1"></a>am1<span class="kw">=</span>al<span class="kw">+</span><span class="fl">2.d0</span><span class="kw">*</span>um</span>
<span id="cb38-15"><a href="#cb38-15" aria-hidden="true" tabindex="-1"></a>am2<span class="kw">=</span>um</span>
<span id="cb38-16"><a href="#cb38-16" aria-hidden="true" tabindex="-1"></a><span class="co">!      </span></span>
<span id="cb38-17"><a href="#cb38-17" aria-hidden="true" tabindex="-1"></a>stress(<span class="dv">1</span>)<span class="kw">=</span>stress(<span class="dv">1</span>)<span class="kw">+</span>am1<span class="kw">*</span>dstran(<span class="dv">1</span>)<span class="kw">+</span>al<span class="kw">*</span>(dstran(<span class="dv">2</span>)<span class="kw">+</span>dstran(<span class="dv">3</span>))</span>
<span id="cb38-18"><a href="#cb38-18" aria-hidden="true" tabindex="-1"></a>stress(<span class="dv">2</span>)<span class="kw">=</span>stress(<span class="dv">2</span>)<span class="kw">+</span>am1<span class="kw">*</span>dstran(<span class="dv">2</span>)<span class="kw">+</span>al<span class="kw">*</span>(dstran(<span class="dv">1</span>)<span class="kw">+</span>dstran(<span class="dv">3</span>))</span>
<span id="cb38-19"><a href="#cb38-19" aria-hidden="true" tabindex="-1"></a>stress(<span class="dv">3</span>)<span class="kw">=</span>stress(<span class="dv">3</span>)<span class="kw">+</span>am1<span class="kw">*</span>dstran(<span class="dv">3</span>)<span class="kw">+</span>al<span class="kw">*</span>(dstran(<span class="dv">1</span>)<span class="kw">+</span>dstran(<span class="dv">2</span>))</span>
<span id="cb38-20"><a href="#cb38-20" aria-hidden="true" tabindex="-1"></a>stress(<span class="dv">4</span>)<span class="kw">=</span>stress(<span class="dv">4</span>)<span class="kw">+</span>am2<span class="kw">*</span>dstran(<span class="dv">4</span>)</span>
<span id="cb38-21"><a href="#cb38-21" aria-hidden="true" tabindex="-1"></a>stress(<span class="dv">5</span>)<span class="kw">=</span>stress(<span class="dv">5</span>)<span class="kw">+</span>am2<span class="kw">*</span>dstran(<span class="dv">5</span>)</span>
<span id="cb38-22"><a href="#cb38-22" aria-hidden="true" tabindex="-1"></a>stress(<span class="dv">6</span>)<span class="kw">=</span>stress(<span class="dv">6</span>)<span class="kw">+</span>am2<span class="kw">*</span>dstran(<span class="dv">6</span>)</span>
<span id="cb38-23"><a href="#cb38-23" aria-hidden="true" tabindex="-1"></a><span class="co">!</span></span>
<span id="cb38-24"><a href="#cb38-24" aria-hidden="true" tabindex="-1"></a><span class="kw">do</span> i<span class="kw">=</span><span class="dv">1</span>,<span class="dv">6</span></span>
<span id="cb38-25"><a href="#cb38-25" aria-hidden="true" tabindex="-1"></a>   <span class="kw">do</span> j<span class="kw">=</span><span class="dv">1</span>,<span class="dv">6</span></span>
<span id="cb38-26"><a href="#cb38-26" aria-hidden="true" tabindex="-1"></a>      ddsdde(i,j)<span class="kw">=</span><span class="fl">0.d0</span></span>
<span id="cb38-27"><a href="#cb38-27" aria-hidden="true" tabindex="-1"></a>   <span class="kw">enddo</span></span>
<span id="cb38-28"><a href="#cb38-28" aria-hidden="true" tabindex="-1"></a><span class="kw">enddo</span></span>
<span id="cb38-29"><a href="#cb38-29" aria-hidden="true" tabindex="-1"></a>ddsdde(<span class="dv">1</span>,<span class="dv">1</span>)<span class="kw">=</span>al<span class="kw">+</span><span class="fl">2.d0</span><span class="kw">*</span>um</span>
<span id="cb38-30"><a href="#cb38-30" aria-hidden="true" tabindex="-1"></a>ddsdde(<span class="dv">1</span>,<span class="dv">2</span>)<span class="kw">=</span>al</span>
<span id="cb38-31"><a href="#cb38-31" aria-hidden="true" tabindex="-1"></a>ddsdde(<span class="dv">2</span>,<span class="dv">1</span>)<span class="kw">=</span>al</span>
<span id="cb38-32"><a href="#cb38-32" aria-hidden="true" tabindex="-1"></a>ddsdde(<span class="dv">2</span>,<span class="dv">2</span>)<span class="kw">=</span>al<span class="kw">+</span><span class="fl">2.d0</span><span class="kw">*</span>um</span>
<span id="cb38-33"><a href="#cb38-33" aria-hidden="true" tabindex="-1"></a>ddsdde(<span class="dv">1</span>,<span class="dv">3</span>)<span class="kw">=</span>al</span>
<span id="cb38-34"><a href="#cb38-34" aria-hidden="true" tabindex="-1"></a>ddsdde(<span class="dv">3</span>,<span class="dv">1</span>)<span class="kw">=</span>al</span>
<span id="cb38-35"><a href="#cb38-35" aria-hidden="true" tabindex="-1"></a>ddsdde(<span class="dv">2</span>,<span class="dv">3</span>)<span class="kw">=</span>al</span>
<span id="cb38-36"><a href="#cb38-36" aria-hidden="true" tabindex="-1"></a>ddsdde(<span class="dv">3</span>,<span class="dv">2</span>)<span class="kw">=</span>al</span>
<span id="cb38-37"><a href="#cb38-37" aria-hidden="true" tabindex="-1"></a>ddsdde(<span class="dv">3</span>,<span class="dv">3</span>)<span class="kw">=</span>al<span class="kw">+</span><span class="fl">2.d0</span><span class="kw">*</span>um</span>
<span id="cb38-38"><a href="#cb38-38" aria-hidden="true" tabindex="-1"></a>ddsdde(<span class="dv">4</span>,<span class="dv">4</span>)<span class="kw">=</span>um</span>
<span id="cb38-39"><a href="#cb38-39" aria-hidden="true" tabindex="-1"></a>ddsdde(<span class="dv">5</span>,<span class="dv">5</span>)<span class="kw">=</span>um</span>
<span id="cb38-40"><a href="#cb38-40" aria-hidden="true" tabindex="-1"></a>ddsdde(<span class="dv">6</span>,<span class="dv">6</span>)<span class="kw">=</span>um</span>
<span id="cb38-41"><a href="#cb38-41" aria-hidden="true" tabindex="-1"></a><span class="kw">return</span></span>
<span id="cb38-42"><a href="#cb38-42" aria-hidden="true" tabindex="-1"></a><span class="kw">end subroutine</span> umat2</span></code></pre></div>
</div>
<h1 class="unnumbered" id="references">References</h1>
<div id="refs" class="references csl-bib-body" role="doc-bibliography">
<div id="ref-Helfer2020" class="csl-entry" role="doc-biblioentry">
<div class="csl-left-margin">1. </div><div class="csl-right-inline"><span class="smallcaps">Helfer</span>, Thomas, <span class="smallcaps">Bleyer</span>, Jeremy, <span class="smallcaps">Frondelius</span>, Tero, <span class="smallcaps">Yashchuk</span>, Ivan, <span class="smallcaps">Nagel</span>, Thomas and <span class="smallcaps">Naumov</span>, Dmitri. <span class="nocase">The MFrontGenericInterfaceSupport project</span>. <em>Journal of Open Source Software</em>. April 2020. Vol. 5, no. 48, p. 2003. DOI <a href="https://doi.org/10.21105/joss.02003">10.21105/joss.02003</a>. Available from: <a href="https://joss.theoj.org/papers/10.21105/joss.02003">https://joss.theoj.org/papers/10.21105/joss.02003</a></div>
</div>
<div id="ref-cea_mgis_2021" class="csl-entry" role="doc-biblioentry">
<div class="csl-left-margin">2. </div><div class="csl-right-inline"><span class="smallcaps">CEA</span>. <span class="nocase">MGIS website</span>. 2021. Available from: <a href="https://thelfer.github.io/mgis/web/index.html">https://thelfer.github.io/mgis/web/index.html</a></div>
</div>
<div id="ref-cea_edf_tfel_tensors_2021" class="csl-entry" role="doc-biblioentry">
<div class="csl-left-margin">3. </div><div class="csl-right-inline"><span class="smallcaps">CEA, EDF</span>. Second and fourth-order tensor objects in <span>TFEL/Math</span>. 2021. Available from: <a href="https://thelfer.github.io/tfel/web/tensors.html">https://thelfer.github.io/tfel/web/tensors.html</a></div>
</div>
</div>
    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
      ga('create', 'UA-62273823-1', 'auto');
      ga('send', 'pageview');
    </script>
  </body>
</html>
