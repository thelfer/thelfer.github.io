<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<!--[if lt IE 7]>      <html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
<!--[if IE 7]>         <html class="no-js lt-ie9 lt-ie8"> <![endif]-->
<!--[if IE 8]>         <html class="no-js lt-ie9"> <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js"> <!--<![endif]-->
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-EN" xml:lang="en-EN">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta http-equiv="Content-Style-Type" content="text/css" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
    <meta name="generator" content="pandoc" />
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <title>Interacting with a finite-strain MFront behaviour in python</title>
        <meta name="author" content="Jérémy Bleyer" />
            <meta name="date" content="2025-01-01" />
        <!-- Place favicon.ico and apple-touch-icon.png in the root directory -->
    <style type="text/css">code{white-space: pre;}</style>
            <style type="text/css">
      pre > code.sourceCode { white-space: pre; position: relative; }
      pre > code.sourceCode > span { line-height: 1.25; }
      pre > code.sourceCode > span:empty { height: 1.2em; }
      .sourceCode { overflow: visible; }
      code.sourceCode > span { color: inherit; text-decoration: inherit; }
      div.sourceCode { margin: 1em 0; }
      pre.sourceCode { margin: 0; }
      @media screen {
      div.sourceCode { overflow: auto; }
      }
      @media print {
      pre > code.sourceCode { white-space: pre-wrap; }
      pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
      }
      pre.numberSource code
        { counter-reset: source-line 0; }
      pre.numberSource code > span
        { position: relative; left: -4em; counter-increment: source-line; }
      pre.numberSource code > span > a:first-child::before
        { content: counter(source-line);
          position: relative; left: -1em; text-align: right; vertical-align: baseline;
          border: none; display: inline-block;
          -webkit-touch-callout: none; -webkit-user-select: none;
          -khtml-user-select: none; -moz-user-select: none;
          -ms-user-select: none; user-select: none;
          padding: 0 4px; width: 4em;
          color: #aaaaaa;
        }
      pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
      div.sourceCode
        {  background-color: #f8f8f8; }
      @media screen {
      pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
      }
      code span.al { color: #ef2929; } /* Alert */
      code span.an { color: #8f5902; font-weight: bold; font-style: italic; } /* Annotation */
      code span.at { color: #204a87; } /* Attribute */
      code span.bn { color: #0000cf; } /* BaseN */
      code span.cf { color: #204a87; font-weight: bold; } /* ControlFlow */
      code span.ch { color: #4e9a06; } /* Char */
      code span.cn { color: #8f5902; } /* Constant */
      code span.co { color: #8f5902; font-style: italic; } /* Comment */
      code span.cv { color: #8f5902; font-weight: bold; font-style: italic; } /* CommentVar */
      code span.do { color: #8f5902; font-weight: bold; font-style: italic; } /* Documentation */
      code span.dt { color: #204a87; } /* DataType */
      code span.dv { color: #0000cf; } /* DecVal */
      code span.er { color: #a40000; font-weight: bold; } /* Error */
      code span.ex { } /* Extension */
      code span.fl { color: #0000cf; } /* Float */
      code span.fu { color: #204a87; font-weight: bold; } /* Function */
      code span.im { } /* Import */
      code span.in { color: #8f5902; font-weight: bold; font-style: italic; } /* Information */
      code span.kw { color: #204a87; font-weight: bold; } /* Keyword */
      code span.op { color: #ce5c00; font-weight: bold; } /* Operator */
      code span.ot { color: #8f5902; } /* Other */
      code span.pp { color: #8f5902; font-style: italic; } /* Preprocessor */
      code span.sc { color: #ce5c00; font-weight: bold; } /* SpecialChar */
      code span.ss { color: #4e9a06; } /* SpecialString */
      code span.st { color: #4e9a06; } /* String */
      code span.va { color: #000000; } /* Variable */
      code span.vs { color: #4e9a06; } /* VerbatimString */
      code span.wa { color: #8f5902; font-weight: bold; font-style: italic; } /* Warning */
    </style>
            <link rel="stylesheet" href="/home/th202608/codes/mgis/master/src/MFrontGenericInterfaceSupport/docs/web/css/main.css" />
        <link rel="stylesheet" href="css/normalize.css"/>
    <link rel="stylesheet" href="css/main.css"/>
        <script
        src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js"
        type="text/javascript"></script>
          </head>
  <body>
    <!--[if lt IE 7]>
        <p class="browsehappy">You are using an <strong>outdated</strong> browser. Please <a href="http://browsehappy.com/">upgrade your browser</a> to improve your experience.</p>
    <![endif]-->
        <header>
      <ul id="nav">
	<li><a href="index.html">Overview</a></li>
	<li><a>Documentation</a>
	  <ul>
	    <li><a href="https://www.theoj.org/joss-papers/joss.02003/10.21105.joss.02003.pdf"> JOSS paper</a></li>
	    <li><a href="bindings-cxx.html">Description of the C++ library</a></li>
	    <li><a href="install.html">Installation guide</a></li>
	    <li><a>Bindings</a>
	        <ul>
		  <li><a>python</a>
	            <ul>
		       <li><a href="bindings-python-finite_strain.html">Interacting with a finite-strain `MFront` behaviour</a></li>
		       <li><a href="bindings-python-small_strain.html">Interacting with a small-strain `MFront` behaviour</a></li>
	            </ul>
                   </li>
	        </ul>
	    </li>
	    <li><a href="mgis_fenics.html">mgis.fenics</a>
	      <ul>
		<li><a href="mgis_fenics.html">Overview of mgis.fenics</a></li>
		<li><a href="mgis_fenics_nonlinear_heat_transfer.html">Stationnary non-linear heat transfer</a></li>
		<li><a href="mgis_fenics_nonlinear_heat_transfer_3D.html">Stationnary non-linear heat transfer: 3D problem and performance comparisons</a></li>
		<li><a href="mgis_fenics_heat_equation_phase_change.html">Transient heat equation with phase change</a></li>
		<li><a href="mgis_fenics_monolithic_transient_thermoelasticity.html">Monolithic transient thermoelasticity</a></li>
		<li><a href="mgis_fenics_small_strain_elastoplasticity.html">Small-strain von Mises elastoplasticity</a></li>
		<li><a href="mgis_fenics_finite_strain_elastoplasticity.html">Finite-strain elastoplasticity within the logarithmic strain framework</a></li>
		<li><a href="mgis_fenics_multiphase_model.html">Multiphase model for fiber-reinforced materials</a></li>
		<li><a href="mgis_fenics_phase_field.html">Phase-field approach to brittle fracture</a></li>
	      </ul>
	    </li>
	    <li><a>Release notes</a>
	      <ul>
		<li><a>Version 1.0.x</a>
		  <ul>
		    <li><a href="release-notes-1.0.2.html">Version 1.0.2</a></li>
		  </ul>
		</li>
		<li><a>Version 1.1.x</a>
		  <ul>
		    <li><a href="release-notes-1.1.html">Version 1.1</a></li>
		    <li><a href="release-notes-1.1.1.html">Version 1.1.1</a></li>
		    <li><a href="release-notes-1.1.2.html">Version 1.1.2</a></li>
		  </ul>
		</li>
		<li><a>Version 1.2.x</a>
		  <ul>
		    <li><a href="release-notes-1.2.html">Version 1.2</a></li>
		    <li><a href="release-notes-1.2.1.html">Version 1.2.1</a></li>
		    <li><a href="release-notes-1.2.2.html">Version 1.2.2</a></li>
		    <li><a href="release-notes-1.2.3.html">Version 1.2.3</a></li>
		  </ul>
		</li>
		<li><a>Version 2.0.x</a>
		  <ul>
		    <li><a href="release-notes-2.0.html">Version 2.0</a></li>
		    <li><a href="release-notes-2.0.1.html">Version 2.0.1</a></li>
		  </ul>
		<li><a>Version 2.1.x</a>
		  <ul>
		    <li><a href="release-notes-2.1.html">Version 2.1</a></li>
		    <li><a href="release-notes-2.1.1.html">Version 2.1.1</a></li>
		  </ul>
		<li><a>Version 2.2.x</a>
		  <ul>
		    <li><a href="release-notes-2.2.html">Version 2.2</a></li>
		    <li><a href="release-notes-2.2.1.html">Version 2.2.1</a></li>
   		    <li><a href="release-notes-2.2.2.html">Version 2.2.2</a></li>
		  </ul>
		</li>
		<li><a>Version 3.0.x</a>
		  <ul>
		    <li><a href="release-notes-3.0.html">Version 3.0</a></li>
		    <li><a href="release-notes-3.0.1.html">Version 3.0.1</a></li>
		  </ul>
		</li>
		<li><a>Version 3.1.x</a>
		  <ul>
		    <li><a href="release-notes-3.1.html">Version 3.1</a></li>
		  </ul>
		</li>
	      </ul>
	    </li>
	    <li><a>Specific topics</a>
	      <ul>
		<li><a href="orthotropic-behaviours.html">Support for orthotropic behaviours</a></li>
		<li><a href="behaviour-integration-failure-analysis.html">Analysing failure of behaviour integration</a></li>
		<li><a href="functions.html">Functions</a></li>
	      </ul>
	    </li>
	    <li><a href="faq.html">FAQ</a></li>
	    <li><a href="about.html">About</a></li>
	  </ul>
	</li>
	<li><a>Contributing</a>
	  <ul>
	    <li><a href="contributing.html">Contributing guidelines</a></li>
	    <li><a href="https://github.com/thelfer/MFrontGenericInterfaceSupport/issues">Report bugs</a></li>
	  </ul>
	</li>
	<li><a>Getting Help</a>
	  <ul>
	    <li><a href="https://github.com/thelfer/MFrontGenericInterfaceSupport/issues">Forum</a></li>
	    <li><a href="mailto:tfel-contact@cea.fr">Contact</a></li>
	  </ul>
	</li>
      </ul>
    </header>
    <br></br>
<div id="header">
<h1 class="title">Interacting with a finite-strain <code>MFront</code>
behaviour in <code>python</code></h1>
<h2 class="author">Jérémy Bleyer</h2>
<h3 class="date">2025</h3>
</div>
<div id="TOC">
<ul>
<li><a href="#objectives" id="toc-objectives">Objectives</a></li>
<li><a href="#problem-setting" id="toc-problem-setting">Problem
setting</a></li>
<li><a href="#implementation" id="toc-implementation">Implementation</a>
<ul>
<li><a href="#compiling-the-behaviour"
id="toc-compiling-the-behaviour">Compiling the behaviour</a></li>
<li><a href="#loading-the-behaviour"
id="toc-loading-the-behaviour">Loading the behaviour</a></li>
<li><a href="#setting-up-the-material-data-manager"
id="toc-setting-up-the-material-data-manager">Setting up the material
data manager</a></li>
<li><a href="#declare-material-properties"
id="toc-declare-material-properties">Declare material
properties</a></li>
<li><a
href="#defining-the-load-stepping-scheme-and-the-nonlinear-system"
id="toc-defining-the-load-stepping-scheme-and-the-nonlinear-system">Defining
the load-stepping scheme and the nonlinear system</a></li>
</ul></li>
</ul>
</div>
<h1 id="objectives">Objectives</h1>
<p>This tutorial shows how we can use the Python <a
href="https://thelfer.github.io/mgis/web/index.html"><code>MFrontGenericSupportInterface</code></a>
to interact with a finite-strain mechanical behaviour compiled with
MFront.</p>
<p>The corresponding behaviour is a finite-strain elastoplastic
behaviour formulated in the framework of logarithmic strains (Hencky
strain measure). Such finite-strain behaviours offer the advantage of
using the same implementation as the small-strain case, except that
strains are now formulated with Hencky strain measures (<span
class="math inline">\(\boldsymbol{H}=\boldsymbol{H}^\text{e}+\boldsymbol{H}^\text{p}\)</span>)
instead of the linearized strain (<span
class="math inline">\(\boldsymbol{\varepsilon}=\boldsymbol{\varepsilon}^\text{e}+\boldsymbol{\varepsilon}^\text{p}\)</span>).
The small-strain elastoplastic component is the same as in the companion
<a href="bindings-python-small_strain.html">small-strain demo</a>.</p>
<p>The following implementation shows:</p>
<ul>
<li>how to read information from the compiled behaviour, such as the
declared internal state variable names or material properties</li>
<li>how to ask for specific stress measures and tangent operator
forms</li>
<li>how to set up material properties</li>
<li>how to impose values for the deformation gradient, call the
behaviour integration for a batch of quadrature points and update the
mechanical state for subsequent time steps</li>
<li>how to locally solve a non-linear system involving the computed
tangent operator</li>
</ul>
<blockquote>
<p><strong>External files</strong></p>
<p>This tutorial can be run in a <code>jupyter</code> notebook using the
following files:</p>
<ul>
<li><a
href="ipynb/mgis_finite_strain.ipynb"><code>mgis_finite_strain.ipynb</code></a></li>
<li><a
href="mfront/LogarithmicStrainPlasticity.mfront"><code>LogarithmicStrainPlasticity.mfront</code></a></li>
</ul>
</blockquote>
<h1 id="problem-setting">Problem setting</h1>
<p>Similarly to the small-strain demo, we aim to solve for a uniaxial
stress state along the <span class="math inline">\(x\)</span> direction,
while controlling the imposed horizontal strain <span
class="math inline">\(\epsilon\)</span>.</p>
<p>In finite-strain the main deformation measure is the deformation
gradient <span class="math inline">\(\boldsymbol{F}\)</span>. We thus
impose an horizontal elongation <span
class="math inline">\(F_{xx}=1+\epsilon\)</span>, the 8 (<span
class="math inline">\(\boldsymbol{F}\)</span> is non-symmetric)
remaining components <span class="math inline">\(F_{ij}\)</span> are
considered as unknowns and we want to solve the following problem at a
given imposed horizontal strain: Find <span
class="math inline">\(\boldsymbol{F}\)</span> such that:</p>
<p><span class="math display">\[
\boldsymbol{R}(\boldsymbol{F}) = \begin{Bmatrix}
F_{xx} - 1-\epsilon \\
P_{yy}(\boldsymbol{F}) \\
P_{zz}(\boldsymbol{F}) \\
P_{xy}(\boldsymbol{F}) \\
P_{yx}(\boldsymbol{F}) \\
P_{xz}(\boldsymbol{F}) \\
P_{zx}(\boldsymbol{F}) \\
P_{yz}(\boldsymbol{F}) \\
P_{zy}(\boldsymbol{F})
\end{Bmatrix} = 0
\]</span> where <span class="math inline">\(\boldsymbol{P}\)</span> is
here the 1st Piola-Kirchhoff stress.</p>
<p>To solve this non-linear problem, we write a custom Newton-Raphson
method which will involve the following <span
class="math inline">\(9x9\)</span> jacobian: <span
class="math display">\[
\boldsymbol{J} = \dfrac{\partial \boldsymbol{R}}{\partial
\boldsymbol{F}} = \begin{bmatrix}
\begin{bmatrix} 1 &amp; 0 &amp; \ldots &amp; 0\end{bmatrix}\\
\bar{C}_\text{tang}
\end{bmatrix}
\]</span> where <span
class="math inline">\(\bar{\boldsymbol{C}}_\text{tang}\)</span> is the
sub-matrix obtained by removing the first row from the tangent stiffness
<span class="math inline">\(\boldsymbol{C}_\text{tang} = \dfrac{\partial
\boldsymbol{P}}{\partial \boldsymbol{F}}\)</span>.</p>
<p>Note that <span class="math inline">\(\boldsymbol{P}\)</span> is also
non-symmetric. However, the formulated behaviour will necessary satisfy
balance of angular momentum and will produce stress states satisfying
<span class="math inline">\(\boldsymbol{P} =
\boldsymbol{F}\boldsymbol{S}\)</span> where <span
class="math inline">\(\boldsymbol{S}\)</span> is the 2nd Piola-Kirchhoff
stress with <span class="math inline">\(\boldsymbol{S}\)</span> being
symmetric. Hence, by construction <span
class="math inline">\(\boldsymbol{P}\boldsymbol{F}^{\text{T}}=\boldsymbol{F}\boldsymbol{P}^{\text{T}}\)</span>.</p>
<p>This property introduces linearly dependent equation in the above
nonlinear system, resulting in a singular <span
class="math inline">\(9x9\)</span> Jacobian matrix. To circumvent this
issue, we will simply solve the Newton iterations in the least-square
sense.</p>
<p>In the following, we will compute the behaviour integration and the
above non-linear resolution for a batch of <code>ngauss</code> points
for illustration purposes. For simplicity, we will impose the same
strain <span class="math inline">\(\epsilon\)</span> for all points,
yielding the same response for all points but different strain values
could also be considered for the different material points.</p>
<blockquote>
<p><strong>Note</strong></p>
<p>To treat a batch of integration points, we rely on the
<code>MaterialDataManager</code> class. This is the most commonly used
class in <code>python</code>.</p>
<p>In contrast, in solvers developped using a compiled language like
<code>C++</code>, <code>fortran</code> and <code>C</code>, most
developers wants more control on how memory is handled. In this case,
<code>mgis</code> provides the <code>BehaviourData</code> and
<code>BehaviourDataView</code> classes which are suitable to deal with a
single integraiton point.</p>
<p>Those various solutions are described in depth in the <a
href="bindings-cxx.html"><code>C++</code> tutorial</a>.</p>
</blockquote>
<blockquote>
<p><strong>Note</strong></p>
<p>This tutorial aims at illustrating how to use <code>MGIS</code> in
<code>python</code> on a simple example.</p>
<p>To describe a single integration point, the usage of the
<code>mtest</code> module (provided by the <code>TFEL</code> project if
the <code>python</code> bindings are enabled) is strongly advocated.</p>
<p>See <a
href="https://thelfer.github.io/tfel/web/mtest-python.html">this
page</a> for details.</p>
</blockquote>
<h1 id="implementation">Implementation</h1>
<h2 id="compiling-the-behaviour">Compiling the behaviour</h2>
<p>First, we call the
<code>mfront --obuild --interface=generic LogarithmicStrainPlasticity.mfront</code>
command to compile the MFront behaviour. This should only be done once
and for all if the behaviour implementation does not change anymore.</p>
<p>Shared libraries are then stored in the
<code>src/libBehaviour.so</code> file which will be used to load the
behaviour.</p>
<div class="sourceCode" id="cb1"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> subprocess</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> mgis.behaviour <span class="im">as</span> mgis_bv</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>behaviour_name <span class="op">=</span> <span class="st">&quot;LogarithmicStrainPlasticity&quot;</span></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>subprocess.call([<span class="st">&quot;mfront&quot;</span>, <span class="st">&quot;--obuild&quot;</span>, <span class="st">&quot;--interface=generic&quot;</span>, behaviour_name<span class="op">+</span><span class="st">&quot;.mfront&quot;</span>])</span></code></pre></div>
<div class="sourceCode" id="cb2"><pre
class="sourceCode txt"><code class="sourceCode default"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>Treating target : all</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>The following library has been built :</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>- libBehaviour.so :  LogarithmicStrainPlasticity_AxisymmetricalGeneralisedPlaneStrain LogarithmicStrainPlasticity_Axisymmetrical LogarithmicStrainPlasticity_PlaneStrain LogarithmicStrainPlasticity_GeneralisedPlaneStrain LogarithmicStrainPlasticity_Tridimensional</span></code></pre></div>
<blockquote>
<p><strong>Note</strong></p>
<p>If the <code>TFEL</code> project (which provides <code>MFront</code>)
has been compiled with the <code>python</code> bindings enabled, then
the <code>mfront</code> <code>python</code> module provides a more
direct way of compiling <code>MFront</code> behaviours, allowing to
retrieve the name of the generated libraries and behaviours.</p>
<p>See <a
href="https://thelfer.github.io/tfel/web/mfront-python.html">this
page</a> for details about the <code>mfront</code> module.</p>
</blockquote>
<h2 id="loading-the-behaviour">Loading the behaviour</h2>
<p>We first need to choose the modeling hypothesis. Here, we will work
with 3D states and thus choose the <code>Tridimensional</code>
hypothesis.</p>
<p>Behaviours are loaded differently depending on whether we work with a
small or finite-strain setting. We use the
<code>isStandardFiniteStrainBehaviour</code> function to check whether
the behaviour is finite strain or not.</p>
<p>For the present finite-strain case, we can specify options asking
which stress measure we want the behaviour to return, we can for
instance choose the Cauchy (<code>CAUCHY</code>) stress <span
class="math inline">\(\boldsymbol{\sigma}\)</span>, the 1st
Piola-Kirchhoff stress (<code>PK1</code>) <span
class="math inline">\(\boldsymbol{P}\)</span> or the 2nd Piola-Kirchhoff
stress (<code>PK2</code>) <span
class="math inline">\(\boldsymbol{S}\)</span>.</p>
<p>We choose the PK1 stress <span
class="math inline">\(\boldsymbol{P}\)</span> here. Similarly, we can
ask for specific variants of the tangent operators such as:</p>
<ul>
<li><code>DCAUCHY_DF</code>/<code>DSIG_DF</code>: <span
class="math inline">\(\dfrac{\partial\boldsymbol{\sigma}}{\partial
\boldsymbol{F}}\)</span>,</li>
<li><code>DPK1_DF</code>: <span
class="math inline">\(\dfrac{\partial\boldsymbol{P}}{\partial
\boldsymbol{F}}\)</span>,</li>
<li><code>DS_DEGL</code>: <span
class="math inline">\(\dfrac{\partial\boldsymbol{S}}{\partial
\boldsymbol{E}^\text{GL}}\)</span>,</li>
<li><code>DTAU_DDF</code>: <span
class="math inline">\(\dfrac{\partial\boldsymbol{\tau}}{\partial
\Delta\,\boldsymbol{F}}\)</span>.</li>
</ul>
<p>where <span class="math inline">\(\boldsymbol{E}^\text{GL}\)</span>
is the Green-Lagrange strain, <span
class="math inline">\(\boldsymbol{\tau}\)</span> the Kirchhoff stress
and <span class="math inline">\(\Delta\,\boldsymbol{F}\)</span> is given
by <span
class="math inline">\(\left.\boldsymbol{F}\right|_{t+dt}\,\cdot\,\left.\boldsymbol{F}\right|_{t}^{-1}\)</span>.</p>
<div class="sourceCode" id="cb3"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>lib_path <span class="op">=</span> <span class="st">&quot;src/libBehaviour.so&quot;</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>hypothesis <span class="op">=</span> mgis_bv.Hypothesis.Tridimensional</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>is_finite_strain <span class="op">=</span> mgis_bv.isStandardFiniteStrainBehaviour(lib_path, behaviour_name)</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> is_finite_strain:</span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">&quot;Finite strain behaviour detected.&quot;</span>)</span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>    bopts <span class="op">=</span> mgis_bv.FiniteStrainBehaviourOptions()</span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>    bopts.stress_measure <span class="op">=</span> mgis_bv.FiniteStrainBehaviourOptionsStressMeasure.PK1</span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a>    bopts.tangent_operator <span class="op">=</span> (</span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a>        mgis_bv.FiniteStrainBehaviourOptionsTangentOperator.DPK1_DF</span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a>    behaviour <span class="op">=</span> mgis_bv.load(bopts, lib_path, behaviour_name, hypothesis)</span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a><span class="cf">else</span>:</span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">&quot;Small strain behaviour detected.&quot;</span>)</span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a>    behaviour <span class="op">=</span> mgis_bv.load(lib_path, behaviour_name, hypothesis)</span></code></pre></div>
<div class="sourceCode" id="cb4"><pre
class="sourceCode txt"><code class="sourceCode default"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>Finite strain behaviour detected.</span></code></pre></div>
<p>The <code>Behaviour</code> object now contains several information
about the behaviour implementation such as names and types of gradients
and thermodynamic forces and external or internal state variables.</p>
<p>Here, we work with a purely mechanical behaviour so that gradients
consist only of the total deformation gradient
<code>DeformationGradient</code>. The resulting thermodynamic stress is
<code>FirstPiolaKirchhoffStress</code>.</p>
<p>By default, <code>Temperature</code> is always declared as an
external state variable by MFront.</p>
<blockquote>
<p><strong>Note</strong></p>
<p>The automatic declaration of the <code>Temperature</code> comes from
the fact that many solvers adopted the <code>UMAT</code> interface which
treats the temperature specifically.</p>
<p>If portability is not an issue (the <code>generic</code> interface is
the only one that supports this feature), the automatic declaration can
be disabled by modifying the declaration of the domain specific language
in the <code>MFront</code> file as follows:</p>
<div class="sourceCode" id="cb5"><pre
class="sourceCode cxx"><code class="sourceCode cpp"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="er">@</span>DSL Implicit<span class="op">{</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>  automatic_declaration_of_the_temperature_as_first_external_state_variable<span class="op">:</span> <span class="kw">false</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
</blockquote>
<p>Finally, since we are dealing with an elastoplastic behaviour with
isotropic hardening, the internal state variables are the
<code>ElasticStrain</code> and the <code>EquivalentPlasticStrain</code>.
The former is a symmetric tensor whereas the latter is only a
scalar.</p>
<div class="sourceCode" id="cb6"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">&quot;Kinematic type:&quot;</span>, behaviour.getKinematic())</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">&quot;Gradient names:&quot;</span>,[s.name <span class="cf">for</span> s <span class="kw">in</span> behaviour.gradients])</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">&quot;Thermodynamic forces names:&quot;</span>, [s.name <span class="cf">for</span> s <span class="kw">in</span> behaviour.thermodynamic_forces])</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">&quot;External state variable names:&quot;</span>,  [s.name <span class="cf">for</span> s <span class="kw">in</span> behaviour.external_state_variables])</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(</span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;Internal state variable names:&quot;</span>,</span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>    [s.name <span class="cf">for</span> s <span class="kw">in</span> behaviour.internal_state_variables],</span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(</span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;Internal state variable types:&quot;</span>,</span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a>    [s.<span class="bu">type</span> <span class="cf">for</span> s <span class="kw">in</span> behaviour.internal_state_variables],</span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div>
<div class="sourceCode" id="cb7"><pre
class="sourceCode txt"><code class="sourceCode default"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>Kinematic type: F_CAUCHY</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>Gradient names: [&#39;DeformationGradient&#39;]</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>Thermodynamic forces names: [&#39;FirstPiolaKirchhoffStress&#39;]</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>External state variable names: [&#39;Temperature&#39;]</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>Internal state variable names: [&#39;ElasticStrain&#39;, &#39;EquivalentPlasticStrain&#39;]</span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>Internal state variable types: [mgis.behaviour.VariableType.STENSOR, mgis.behaviour.VariableType.SCALAR]</span></code></pre></div>
<p>The size of these different quantities can be checked. Non-symmetric
tensors in 3D are represented here as arrays of size 9, see <a
href="https://thelfer.github.io/tfel/web/tensors.html">Tensors in
MFront</a>.</p>
<div class="sourceCode" id="cb8"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> s <span class="kw">in</span> behaviour.gradients <span class="op">+</span> behaviour.thermodynamic_forces <span class="op">+</span> behaviour.internal_state_variables: </span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f&quot;</span><span class="sc">{</span>s<span class="sc">.</span>name<span class="sc">}</span><span class="ss"> is of size </span><span class="sc">{</span>mgis_bv<span class="sc">.</span>getVariableSize(s, hypothesis)<span class="sc">}</span><span class="ss">&quot;</span>)</span></code></pre></div>
<div class="sourceCode" id="cb9"><pre
class="sourceCode txt"><code class="sourceCode default"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>DeformationGradient is of size 9</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>FirstPiolaKirchhoffStress is of size 9</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>ElasticStrain is of size 6</span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>EquivalentPlasticStrain is of size 1</span></code></pre></div>
<p>For more complex behaviours, different “blocks” of tangent operators
can be declared and computed. The names of the tangent blocks can be
retrieved as shown below. Here, we have a simple mechanical behaviour so
that the only tangent operator is the tangent stiffness <span
class="math inline">\(\boldsymbol{C}_\text{tang} = \dfrac{\partial
\boldsymbol{P}}{\partial \boldsymbol{F}}\)</span>, as specified
earlier.</p>
<div class="sourceCode" id="cb10"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;Tangent operator block names:&quot;</span>,</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>    [<span class="ss">f&quot;d</span><span class="sc">{</span>s[<span class="dv">0</span>]<span class="sc">.</span>name<span class="sc">}</span><span class="ss">_d</span><span class="sc">{</span>s[<span class="dv">1</span>]<span class="sc">.</span>name<span class="sc">}</span><span class="ss">&quot;</span> <span class="cf">for</span> s <span class="kw">in</span> behaviour.tangent_operator_blocks],</span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div>
<div class="sourceCode" id="cb11"><pre
class="sourceCode txt"><code class="sourceCode default"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>Tangent operator block names: [&#39;dFirstPiolaKirchhoffStress_dDeformationGradient&#39;]</span></code></pre></div>
<p>Finally, names of material properties can also be retrieved easily as
follows:</p>
<div class="sourceCode" id="cb12"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;Material property names:&quot;</span>,</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>    [s.name <span class="cf">for</span> s <span class="kw">in</span> behaviour.material_properties],</span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div>
<div class="sourceCode" id="cb13"><pre
class="sourceCode txt"><code class="sourceCode default"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>Material property names: [&#39;InitialYieldStress&#39;, &#39;FinalYieldStress&#39;, &#39;HardeningCoefficient&#39;]</span></code></pre></div>
<p>Other informations such as behaviour material symmetry or predefined
parameters can also be obtained as follows:</p>
<div class="sourceCode" id="cb14"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(behaviour.symmetry)</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(behaviour.parameters)</span></code></pre></div>
<div class="sourceCode" id="cb15"><pre
class="sourceCode txt"><code class="sourceCode default"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>Isotropic</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>[&#39;epsilon&#39;, &#39;theta&#39;, &#39;YoungModulus&#39;, &#39;PoissonRatio&#39;, &#39;RelativeValueForTheEquivalentStressLowerBoundDefinition&#39;, &#39;minimal_time_step_scaling_factor&#39;, &#39;maximal_time_step_scaling_factor&#39;, &#39;numerical_jacobian_epsilon&#39;]</span></code></pre></div>
<h2 id="setting-up-the-material-data-manager">Setting up the material
data manager</h2>
<p>The material data manager will be the data structure which will hold
the information about the mechanical state and tangent operator for a
single or a batch of integration points during a given time step. We
first set up the data manager by declaring the number of integration
points we want to handle.</p>
<div class="sourceCode" id="cb16"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>ngauss <span class="op">=</span> <span class="dv">3</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>data <span class="op">=</span> mgis_bv.MaterialDataManager(behaviour, ngauss)</span></code></pre></div>
<p>Values at the beginning of the time step will be stored in
<code>data.s0</code>. This object is a <code>StateManager</code> which
holds values of the gradients, thermodynamic forces and internal state
variables.</p>
<p>A similar one is stored in <code>data.s1</code> which will hold
values at the end of the current time step, once behaviour integration
has been performed.</p>
<p>Here, by default, <code>DeformationGradient</code> is initialized
with the identity tensor, all other variables at initialized at
zero.</p>
<p>We see below that <code>data.s0.gradients</code> is of shape
<code>ngauss x 9</code> corresponding to the 9 components of the
<code>ngauss</code> integration points.</p>
<div class="sourceCode" id="cb17"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">&quot;Gradients:&quot;</span>)</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">&quot;  Beginning of time step:</span><span class="ch">\n</span><span class="st">&quot;</span>, data.s0.gradients)</span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">&quot;  End of time step:</span><span class="ch">\n</span><span class="st">&quot;</span>, data.s1.gradients)</span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">&quot;Thermodynamic forces:&quot;</span>)</span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">&quot;  Beginning of time step:</span><span class="ch">\n</span><span class="st">&quot;</span>, data.s0.thermodynamic_forces)</span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">&quot;  End of time step:</span><span class="ch">\n</span><span class="st">&quot;</span>, data.s1.thermodynamic_forces)</span></code></pre></div>
<div class="sourceCode" id="cb18"><pre
class="sourceCode txt"><code class="sourceCode default"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>Gradients:</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>  Beginning of time step:</span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a> [[1. 1. 1. 0. 0. 0. 0. 0. 0.]</span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a> [1. 1. 1. 0. 0. 0. 0. 0. 0.]</span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a> [1. 1. 1. 0. 0. 0. 0. 0. 0.]]</span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a>  End of time step:</span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a> [[1. 1. 1. 0. 0. 0. 0. 0. 0.]</span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a> [1. 1. 1. 0. 0. 0. 0. 0. 0.]</span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a> [1. 1. 1. 0. 0. 0. 0. 0. 0.]]</span>
<span id="cb18-10"><a href="#cb18-10" aria-hidden="true" tabindex="-1"></a>Thermodynamic forces:</span>
<span id="cb18-11"><a href="#cb18-11" aria-hidden="true" tabindex="-1"></a>  Beginning of time step:</span>
<span id="cb18-12"><a href="#cb18-12" aria-hidden="true" tabindex="-1"></a> [[0. 0. 0. 0. 0. 0. 0. 0. 0.]</span>
<span id="cb18-13"><a href="#cb18-13" aria-hidden="true" tabindex="-1"></a> [0. 0. 0. 0. 0. 0. 0. 0. 0.]</span>
<span id="cb18-14"><a href="#cb18-14" aria-hidden="true" tabindex="-1"></a> [0. 0. 0. 0. 0. 0. 0. 0. 0.]]</span>
<span id="cb18-15"><a href="#cb18-15" aria-hidden="true" tabindex="-1"></a>  End of time step:</span>
<span id="cb18-16"><a href="#cb18-16" aria-hidden="true" tabindex="-1"></a> [[0. 0. 0. 0. 0. 0. 0. 0. 0.]</span>
<span id="cb18-17"><a href="#cb18-17" aria-hidden="true" tabindex="-1"></a> [0. 0. 0. 0. 0. 0. 0. 0. 0.]</span>
<span id="cb18-18"><a href="#cb18-18" aria-hidden="true" tabindex="-1"></a> [0. 0. 0. 0. 0. 0. 0. 0. 0.]]</span></code></pre></div>
<p>Conversely, internal state variables are of shape
<code>ngauss x 7</code> with components of <code>ElasticStrain</code>
and <code>EquivalentPlasticStrain</code> being concatenated.</p>
<div class="sourceCode" id="cb19"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">&quot;Internal state variables:&quot;</span>)</span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">&quot;  Beginning of time step:</span><span class="ch">\n</span><span class="st">&quot;</span>, data.s0.internal_state_variables)</span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">&quot;  End of time step:</span><span class="ch">\n</span><span class="st">&quot;</span>, data.s1.internal_state_variables)</span></code></pre></div>
<div class="sourceCode" id="cb20"><pre
class="sourceCode txt"><code class="sourceCode default"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>Internal state variables:</span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>  Beginning of time step:</span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a> [[0. 0. 0. 0. 0. 0. 0.]</span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a> [0. 0. 0. 0. 0. 0. 0.]</span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a> [0. 0. 0. 0. 0. 0. 0.]]</span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a>  End of time step:</span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a> [[0. 0. 0. 0. 0. 0. 0.]</span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a> [0. 0. 0. 0. 0. 0. 0.]</span>
<span id="cb20-9"><a href="#cb20-9" aria-hidden="true" tabindex="-1"></a> [0. 0. 0. 0. 0. 0. 0.]]</span></code></pre></div>
<h2 id="declare-material-properties">Declare material properties</h2>
<p>In order to perform the behaviour integration, we need to declare the
values for the material properties which are yet unspecified. We also
need to declare the value of the temperature, although it is not used in
practice. Note that we can declare different values at the beginning and
at the end of the time step, although here we use the same values.
Finally, we would also apply different values for the different
integration points, if needed.</p>
<div class="sourceCode" id="cb21"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> state_manager <span class="kw">in</span> [data.s0, data.s1]:</span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>    mgis_bv.setMaterialProperty(state_manager, <span class="st">&quot;InitialYieldStress&quot;</span>, <span class="fl">250e6</span>)</span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>    mgis_bv.setMaterialProperty(state_manager, <span class="st">&quot;FinalYieldStress&quot;</span>, <span class="fl">400e6</span>)</span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>    mgis_bv.setMaterialProperty(state_manager, <span class="st">&quot;HardeningCoefficient&quot;</span>, <span class="fl">1000.</span>)</span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a>    mgis_bv.setExternalStateVariable(state_manager, <span class="st">&quot;Temperature&quot;</span>, <span class="fl">293.15</span>)</span></code></pre></div>
<h2
id="defining-the-load-stepping-scheme-and-the-nonlinear-system">Defining
the load-stepping scheme and the nonlinear system</h2>
<p>Below, we will impose a cyclic loading in terms of imposed horizontal
strain. The value of the time step <code>dt</code> must be provided but
is irrelevant here since we are dealing with a rate-independent
behaviour.</p>
<div class="sourceCode" id="cb22"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="co"># strain history</span></span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>N <span class="op">=</span> <span class="dv">20</span></span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>eps_max <span class="op">=</span> <span class="fl">3e-3</span></span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a>eps_list <span class="op">=</span> np.concatenate((np.linspace(<span class="dv">0</span>, eps_max, N), np.linspace(eps_max, <span class="op">-</span>eps_max, N), np.linspace(<span class="op">-</span>eps_max, <span class="dv">0</span>, N))<span class="op">*</span><span class="dv">2</span>)</span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a>lambda_list <span class="op">=</span> <span class="dv">1</span> <span class="op">+</span> eps_list</span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a>dt <span class="op">=</span> <span class="dv">0</span></span></code></pre></div>
<p>We now implement the expression of the global residual <span
class="math inline">\(\boldsymbol{R}\)</span> and its jacobian <span
class="math inline">\(\boldsymbol{J}\)</span>. As stresses are expressed
here in Pa, we use a scaling of <code>1e-9</code> to scale the stress
components to values close to strain values.</p>
<div class="sourceCode" id="cb23"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>stress_scaling <span class="op">=</span> <span class="fl">1e-9</span></span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> residual(F, P, lamb):</span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> np.concatenate((F[:, [<span class="dv">0</span>]] <span class="op">-</span> lamb, P[:, <span class="dv">1</span>:] <span class="op">*</span> stress_scaling), axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> jacobian(F, P, Ct):</span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a>    Jac <span class="op">=</span> np.zeros((ngauss, <span class="dv">9</span>, <span class="dv">9</span>))</span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a>    Jac[:,<span class="dv">0</span>,<span class="dv">0</span>] <span class="op">=</span> <span class="dv">1</span></span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a>    Jac[:,<span class="dv">1</span>:,:] <span class="op">=</span> Ct[:,<span class="dv">1</span>:,:]<span class="op">*</span>stress_scaling</span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> Jac</span></code></pre></div>
<p>Integration of the material behaviour will be done by specifying that
we want to compute the consistent tangent operator. We then implement
the time stepping loop and the Newton-Raphson resolution.</p>
<p>We recall that the values of the total deformation gradient are all
assumed to be unknown and will be stored in the <code>F</code> variable,
the latter being initialized with the deformation gradient values at the
beginning of the time step.</p>
<p>During a Newton-Raphson iteration, the deformation gradient values at
the end of the time step are updated with the current value for
<code>F</code>.</p>
<p>Then, integration is performed using
<code>mgis_bv.integrate</code>.</p>
<p>Next, we retrieve the new value for the stress, stored in
<code>P</code> and of the tangent operator, stored in <code>Ct</code>.
We evaluate the residual <span
class="math inline">\(\boldsymbol{R}\)</span> and perform the Newton
correction to <code>eps</code> by solving the jacobian system (in the
least square sense as discussed above).</p>
<p>Finally, we report the horizontal stress value at the first
integration point (we can check that all <code>ngauss</code> points give
the same value).</p>
<p>Before going to the next load step, the computed state must be
updated using <code>mgis_bv.update(data)</code> which copies the
computed state <code>s1</code> into <code>s0</code>.</p>
<div class="sourceCode" id="cb24"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>integration_type <span class="op">=</span> mgis_bv.IntegrationType.IntegrationWithConsistentTangentOperator</span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>rtol <span class="op">=</span> <span class="fl">1e-8</span></span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a>atol <span class="op">=</span> <span class="fl">1e-8</span></span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a>niter_max <span class="op">=</span> <span class="dv">20</span></span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a>Sxx <span class="op">=</span> np.zeros_like(lambda_list)</span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i, lamb_imposed <span class="kw">in</span> <span class="bu">enumerate</span>(lambda_list):</span>
<span id="cb24-8"><a href="#cb24-8" aria-hidden="true" tabindex="-1"></a>    F <span class="op">=</span> np.copy(data.s0.gradients)</span>
<span id="cb24-9"><a href="#cb24-9" aria-hidden="true" tabindex="-1"></a>    P <span class="op">=</span> np.copy(data.s0.thermodynamic_forces)</span>
<span id="cb24-10"><a href="#cb24-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-11"><a href="#cb24-11" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Newton-Raphson solve</span></span>
<span id="cb24-12"><a href="#cb24-12" aria-hidden="true" tabindex="-1"></a>    nres <span class="op">=</span> <span class="dv">1</span></span>
<span id="cb24-13"><a href="#cb24-13" aria-hidden="true" tabindex="-1"></a>    nres0 <span class="op">=</span> <span class="bu">max</span>(np.linalg.norm(residual(F, P, lamb_imposed),axis<span class="op">=</span><span class="dv">1</span>))</span>
<span id="cb24-14"><a href="#cb24-14" aria-hidden="true" tabindex="-1"></a>    niter <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb24-15"><a href="#cb24-15" aria-hidden="true" tabindex="-1"></a>    <span class="cf">while</span> (nres <span class="op">&gt;</span> <span class="bu">max</span>(atol, rtol<span class="op">*</span>nres0)) <span class="kw">and</span> (niter <span class="op">&lt;</span> niter_max):</span>
<span id="cb24-16"><a href="#cb24-16" aria-hidden="true" tabindex="-1"></a>        data.s1.gradients[:] <span class="op">=</span> F</span>
<span id="cb24-17"><a href="#cb24-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-18"><a href="#cb24-18" aria-hidden="true" tabindex="-1"></a>        integration_status <span class="op">=</span> mgis_bv.integrate(data, integration_type, dt, <span class="dv">0</span>, data.n)</span>
<span id="cb24-19"><a href="#cb24-19" aria-hidden="true" tabindex="-1"></a>        <span class="cf">assert</span> integration_status <span class="op">&gt;</span> <span class="dv">0</span>, <span class="st">&quot;Behaviour integration has failed.&quot;</span></span>
<span id="cb24-20"><a href="#cb24-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-21"><a href="#cb24-21" aria-hidden="true" tabindex="-1"></a>        P <span class="op">=</span> data.s1.thermodynamic_forces</span>
<span id="cb24-22"><a href="#cb24-22" aria-hidden="true" tabindex="-1"></a>        Ct <span class="op">=</span> data.K</span>
<span id="cb24-23"><a href="#cb24-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-24"><a href="#cb24-24" aria-hidden="true" tabindex="-1"></a>        res <span class="op">=</span> residual(F, P, lamb_imposed)</span>
<span id="cb24-25"><a href="#cb24-25" aria-hidden="true" tabindex="-1"></a>        nres <span class="op">=</span> <span class="bu">max</span>(np.linalg.norm(res, axis<span class="op">=</span><span class="dv">1</span>))</span>
<span id="cb24-26"><a href="#cb24-26" aria-hidden="true" tabindex="-1"></a>        <span class="co"># print(f&quot;Iteration {niter}, residual = {nres}&quot;)</span></span>
<span id="cb24-27"><a href="#cb24-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-28"><a href="#cb24-28" aria-hidden="true" tabindex="-1"></a>        Jac <span class="op">=</span> jacobian(F, P, Ct)</span>
<span id="cb24-29"><a href="#cb24-29" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> k <span class="kw">in</span> <span class="bu">range</span>(ngauss):</span>
<span id="cb24-30"><a href="#cb24-30" aria-hidden="true" tabindex="-1"></a>            F[k,:] <span class="op">+=</span> np.linalg.lstsq(Jac[k,:,:], <span class="op">-</span>res[k,:])[<span class="dv">0</span>]</span>
<span id="cb24-31"><a href="#cb24-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-32"><a href="#cb24-32" aria-hidden="true" tabindex="-1"></a>        niter <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb24-33"><a href="#cb24-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-34"><a href="#cb24-34" aria-hidden="true" tabindex="-1"></a>    Sxx[i] <span class="op">=</span> data.s1.thermodynamic_forces[<span class="dv">0</span>, <span class="dv">0</span>]</span>
<span id="cb24-35"><a href="#cb24-35" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb24-36"><a href="#cb24-36" aria-hidden="true" tabindex="-1"></a>    mgis_bv.update(data)</span></code></pre></div>
<p>Plotting the horizontal stress strain evolutions shows the expected
behaviour with a first yielding at 250 MPa and a saturation at 400 MPa
in both tension and compression. Note that we do not observe much
difference here compared to the small-strain case because of the chosen
material properties and strain levels.</p>
<div class="sourceCode" id="cb25"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="vs">r&quot;Horizontal elongation $F_</span><span class="sc">{xx}</span><span class="vs">-1$&quot;</span>)</span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="vs">r&quot;Horizontal nominal stress $P_</span><span class="sc">{xx}</span><span class="vs">$ [MPa]&quot;</span>)</span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a>plt.plot(eps_list, Sxx<span class="op">*</span><span class="fl">1e-6</span>, <span class="st">&#39;-o&#39;</span>)</span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a>plt.xlim(<span class="op">-</span><span class="fl">1.2</span><span class="op">*</span>eps_max, <span class="fl">1.2</span><span class="op">*</span>eps_max)</span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a>plt.ylim(<span class="op">-</span><span class="dv">500</span>, <span class="dv">500</span>)</span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code></pre></div>
<figure>
<img src="img/bindings-python-finite_strain.png" alt="png" />
<figcaption aria-hidden="true">png</figcaption>
</figure>
</body>
</html>
